<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokéTeams - Comparte y Descubre Equipos Pokémon</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #ff5350; --primary-dark: #d13330; --secondary: #3b4cca; --light: #f8f9fa;
            --dark: #343a40; --success: #30c58b; --danger: #dc3545;
            --type-normal: #A8A77A; --type-fire: #EE8130; --type-water: #6390F0; --type-electric: #F7D02C;
            --type-grass: #7AC74C; --type-ice: #96D9D6; --type-fighting: #C22E28; --type-poison: #A33EA1;
            --type-ground: #E2BF65; --type-flying: #A98FF3; --type-psychic: #F95587; --type-bug: #A6B91A;
            --type-rock: #B6A136; --type-ghost: #735797; --type-dragon: #6F35FC; --type-dark: #705746;
            --type-steel: #B7B7CE; --type-fairy: #D685AD;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #f4f4f4; color: var(--dark); line-height: 1.6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; }
        header { background-color: var(--primary); color: white; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .navbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; text-decoration: none; color: white;}
        .logo span { color: var(--secondary); }
        .nav-links { display: flex; list-style: none; flex-wrap: wrap; padding-left: 0;}
        .nav-links li { margin-left: 1rem; margin-bottom: 0.5rem; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s, background-color 0.3s; padding: 0.3rem 0.5rem; border-radius: 5px; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background-color: white; }
        
        .auth-section, #create-team-section { background-color: white; padding: 2rem; margin: 2rem auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 750px; }
        .auth-section h2, #create-team-section h2 { text-align: center; color: var(--primary); margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
        .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="password"], .form-group input[type="url"], .form-group input[type="number"], .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; transition: border-color 0.3s; box-sizing: border-box; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--secondary); outline: none; }
        
        .auth-button, .submit-team-button, .action-button { background-color: var(--secondary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 25px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; display: block; width: 100%; margin-top: 1.5rem; }
        .auth-button:hover, .submit-team-button:hover, .action-button:hover { background-color: #2a3ba9; }
        .action-button { background-color: var(--success); margin-top:0.5rem; font-size:0.9rem; padding: 0.5rem 1rem;}

        .auth-toggle-link { display: block; text-align: center; margin-top: 1.5rem; color: var(--primary); text-decoration: none; font-weight: 500; }
        .auth-toggle-link:hover { text-decoration: underline; }
        .feedback-message { padding: 0.75rem; margin-top: 1rem; border-radius: 5px; text-align: center; font-size: 0.9rem;}
        .feedback-message.success { background-color: var(--success); color: white; }
        .feedback-message.error { background-color: var(--danger); color: white; }
        
        #login-section, #register-section, #create-team-section { display: none; } 
        #user-greeting { display: none; color: white; font-weight: 500; margin-left: 1rem; align-self: center;}

        .pokemon-form-block { border: 1px solid #eee; background-color:#f9f9f9; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 8px; }
        .pokemon-form-block h4 { color: var(--secondary); margin-bottom: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; }
        .evs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.75rem; align-items: center; margin-bottom: 0.5rem;}
        .evs-grid label { font-size: 0.85rem; text-align: center;}
        .evs-grid input[type="number"] { text-align: center; padding: 0.5rem; font-size:0.9rem; }
        .ev-total { font-weight: bold; margin-top: 0.5rem; text-align: right; font-size: 0.9rem;}
        .moves-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }

        .search-bar { background-color: white; border-radius: 25px; padding: 0.6rem 1rem; margin: 1rem auto; display: flex; align-items: center; width: 100%; max-width: 600px; }
        .search-bar input { flex: 1; border: none; outline: none; font-size: 0.9rem; padding-right: 1rem; }
        .search-bar button { background-color: var(--secondary); color: white; border: none; border-radius: 20px; padding: 0.4rem 1rem; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .search-bar button:hover { background-color: #2a3ba9; }
        main.container { padding-top: 1rem; padding-bottom: 2rem; }
        .featured-section { margin: 2rem 0; }
        .section-title { font-size: 1.8rem; margin-bottom: 1.5rem; border-bottom: 3px solid var(--primary); padding-bottom: 0.5rem; display: inline-block; }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .team-card { background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; display: flex; flex-direction: column; }
        .team-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .team-header { background-color: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .team-title { font-size: 1.2rem; font-weight: bold; }
        .team-format { background-color: var(--secondary); padding: 0.3rem 0.6rem; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
        .team-pokemon-preview { display: flex; justify-content: space-around; padding: 1rem; flex-wrap: wrap; }
        .pokemon-icon-preview { text-align: center; margin: 0.25rem; width: calc(100%/3 - 1rem); max-width: 80px; }
        .pokemon-icon-preview img { width: 60px; height: 60px; object-fit: contain; border-radius: 50%; background-color: #e9e9e9; border: 1px solid #ccc; margin-bottom: 0.2rem; image-rendering: pixelated; }
        .pokemon-name-preview { font-size: 0.75rem; margin-top: 0.1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }
        .team-footer { padding: 1rem; background-color: #f8f8f8; border-top: 1px solid #eee; font-size: 0.9rem; margin-top: auto; }
        .team-footer-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap;}
        .team-stats { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .stat { display: flex; align-items: center; gap: 0.3rem; }
        .team-creator { font-weight: 500; color: var(--secondary); white-space: nowrap; }
        .team-actions { display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.5rem; }
        .team-action-button { background-color: var(--secondary); color: white; border: none; border-radius: 20px; padding: 0.5rem 1rem; cursor: pointer; font-weight: bold; transition: background-color 0.3s; font-size: 0.8rem; flex-grow: 1; text-align: center; }
        .team-action-button.view-details { background-color: var(--success); }
        .team-action-button:hover { filter: brightness(110%); }
        .cta-section { text-align: center; margin: 3rem 0; padding: 2.5rem 1rem; background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .cta-title { font-size: 2.2rem; margin-bottom: 1rem; }
        .cta-description { max-width: 600px; margin: 0 auto 1.5rem; line-height: 1.7; font-size: 1.1rem; }
        .cta-button { background-color: white; color: var(--primary); text-decoration: none; padding: 0.9rem 2.2rem; border-radius: 25px; font-weight: bold; display: inline-block; transition: all 0.3s; border: 2px solid transparent; }
        .cta-button:hover { background-color: transparent; color: white; border-color: white; transform: translateY(-3px); }
        .categories-section { margin: 2rem 0; }
        .category-list { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0; justify-content: center; }
        .category-item { background-color: white; padding: 0.8rem 1.5rem; border-radius: 25px; font-weight: 500; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd; }
        .category-item:hover, .category-item.active { background-color: var(--secondary); color: white; border-color: var(--secondary); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        footer { background-color: var(--dark); color: white; padding: 3rem 0 2rem; margin-top: 3rem; }
        .footer-content { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 2rem; margin-bottom: 2rem; }
        .footer-column { flex: 1; min-width: 220px; }
        .footer-column h3 { margin-bottom: 1.2rem; font-size: 1.3rem; color: var(--primary); }
        .footer-column p { color: #ccc; line-height: 1.7; }
        .footer-links { list-style: none; padding-left: 0; }
        .footer-links li { margin-bottom: 0.8rem; }
        .footer-links a { color: #aaa; text-decoration: none; transition: color 0.3s, padding-left 0.3s; }
        .footer-links a:hover { color: white; padding-left: 5px; }
        .footer-bottom { margin-top: 2rem; text-align: center; padding-top: 2rem; border-top: 1px solid #555; color: #aaa; font-size: 0.9rem; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="#" id="nav-logo-link" class="logo">Poké<span>Teams</span></a>
                <ul class="nav-links">
                    <li><a href="#" id="home-link" class="active">Inicio</a></li>
                    <li><a href="#" id="popular-link">Populares</a></li>
                    <li id="create-team-nav-link" style="display:none;"><a href="#">Crear Equipo</a></li>
                    <li id="login-nav-link"><a href="#">Iniciar Sesión</a></li>
                    <li id="register-nav-link"><a href="#">Registrarse</a></li>
                    <li id="logout-nav-link" style="display:none;"><a href="#">Cerrar Sesión</a></li>
                    <li id="user-greeting"></li>
                </ul>
            </div>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Buscar equipos, Pokémon o usuarios...">
                <button id="search-button">Buscar</button>
                </div>
        </div>
    </header>

    <main class="container">
        <section id="login-section" class="auth-section">
            <h2>Iniciar Sesión</h2>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" name="email" required></div>
                <div class="form-group"><label for="login-password">Contraseña</label><input type="password" id="login-password" name="password" required></div>
                <button type="submit" class="auth-button">Entrar</button>
            </form>
            <div id="login-feedback" class="feedback-message" style="display:none;"></div>
            <a href="#" id="show-register-link" class="auth-toggle-link">¿No tienes cuenta? Regístrate</a>
        </section>

        <section id="register-section" class="auth-section">
            <h2>Crear Cuenta</h2>
            <form id="register-form">
                <div class="form-group"><label for="register-username">Nombre de Usuario</label><input type="text" id="register-username" name="username" required></div>
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" name="email" required></div>
                <div class="form-group"><label for="register-password">Contraseña (mín. 6 caracteres)</label><input type="password" id="register-password" name="password" required minlength="6"></div>
                <button type="submit" class="auth-button">Registrarse</button>
            </form>
            <div id="register-feedback" class="feedback-message" style="display:none;"></div>
            <a href="#" id="show-login-link" class="auth-toggle-link">¿Ya tienes cuenta? Inicia Sesión</a>
        </section>

        <section id="create-team-section">
            <h2>Crear Nuevo Equipo Pokémon</h2>
            <form id="create-team-form">
                <div class="form-group">
                    <label for="team-title-input">Título del Equipo</label>
                    <input type="text" id="team-title-input" name="teamTitle" required>
                </div>
                <div class="form-group">
                    <label for="team-format-input">Formato de Competición</label>
                    <select id="team-format-input" name="teamFormat" required>
                        <option value="">Selecciona un formato...</option>
                        <option value="VGC 2025 Series 1">VGC 2025 Series 1</option>
                        <option value="VGC 2024 Regulation G">VGC 2024 Regulation G</option>
                        <option value="OU (OverUsed) Singles">OU (OverUsed) Singles</option>
                        <option value="UU (UnderUsed) Singles">UU (UnderUsed) Singles</option>
                        <option value="RU (RarelyUsed) Singles">RU (RarelyUsed) Singles</option>
                        <option value="NU (NeverUsed) Singles">NU (NeverUsed) Singles</option>
                        <option value="PU (PartiallyUsed) Singles">PU (PartiallyUsed) Singles</option>
                        <option value="LC (Little Cup)">LC (Little Cup)</option>
                        <option value="Doubles OU">Doubles OU</option>
                        <option value="Monotype">Monotype</option>
                        <option value="Battle Stadium Singles (BSS)">Battle Stadium Singles (BSS)</option>
                        <option value="Battle Stadium Doubles (BSD)">Battle Stadium Doubles (BSD)</option>
                        <option value="Anything Goes (AG)">Anything Goes (AG)</option>
                        <option value="Custom Game">Custom Game</option>
                        <option value="Other">Otro</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="pokepaste-import-input">Importar desde Pokepaste.es (Opcional)</label>
                    <input type="url" id="pokepaste-import-input" name="pokepasteImportLink" placeholder="Pega aquí el enlace de Pokepaste.es">
                    <button type="button" id="import-pokepaste-button" class="action-button">Importar Datos</button>
                </div>
                <div class="form-group">
                    <label for="team-description-input">Descripción / Guía del Equipo</label>
                    <textarea id="team-description-input" name="teamDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="team-youtube-input">Enlace de YouTube (Opcional)</label>
                    <input type="url" id="team-youtube-input" name="teamYoutubeLink" placeholder="https://www.youtube.com/watch?v=...">
                </div>
                <h3 style="color: var(--secondary); margin-top: 2rem; margin-bottom: 1rem;">Pokémon del Equipo (6)</h3>
                <div id="pokemon-forms-container"></div>
                <button type="submit" class="submit-team-button">Guardar Equipo</button>
            </form>
            <div id="create-team-feedback" class="feedback-message" style="display:none;"></div>
        </section>

        <div id="main-content">
            <section class="featured-section">
                <h2 class="section-title">Equipos Destacados</h2>
                <div class="team-grid" id="team-grid-destacados"></div>
            </section>
            <section class="cta-section">
                <h2 class="cta-title">Crea y Comparte Tu Propio Equipo</h2>
                <p class="cta-description">¿Tienes una combinación ganadora? Compártela con la comunidad.</p>
                <a href="#" id="create-team-cta-button" class="cta-button">Crear Equipo</a>
            </section>
            <section class="categories-section">
                <h2 class="section-title">Explorar por Formato</h2>
                <div class="category-list">
                    <div class="category-item active">Todos</div><div class="category-item">VGC 2025</div><div class="category-item">OU Singles</div>
                    <div class="category-item">UU Singles</div> <div class="category-item">Doubles</div> <div class="category-item">Monotype</div>
                </div>
            </section>
            <section class="featured-section">
                <h2 class="section-title">Equipos Populares</h2>
                <div class="team-grid" id="team-grid-populares"><p style="grid-column: 1 / -1; text-align: center;">Más equipos populares próximamente...</p></div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column"><h3>Poké<span>Teams</span></h3><p>La comunidad para compartir equipos Pokémon.</p></div>
                <div class="footer-column"><h3>Enlaces</h3><ul class="footer-links"><li><a href="#">Inicio</a></li><li><a href="#" id="footer-create-team-link">Crear Equipo</a></li><li><a href="#">Guías</a></li></ul></div>
                <div class="footer-column"><h3>Recursos</h3><ul class="footer-links"><li><a href="#">Base de Datos Pokémon</a></li><li><a href="#">Calculadora</a></li></ul></div>
                <div class="footer-column"><h3>Información</h3><ul class="footer-links"><li><a href="#">Acerca de</a></li><li><a href="#">Privacidad</a></li></ul></div>
            </div>
            <div class="footer-bottom"><p>© 2025 PokéTeams. Pokémon y sus personajes son marcas de Nintendo.</p></div>
        </div>
    </footer>

    <datalist id="pokemon-list"></datalist>
    <datalist id="item-list"></datalist>
    <datalist id="ability-list"></datalist>
    <datalist id="move-list"></datalist>
    <datalist id="nature-list">
        <option value="Adamant"></option><option value="Bashful"></option><option value="Bold"></option>
        <option value="Brave"></option><option value="Calm"></option><option value="Careful"></option>
        <option value="Docile"></option><option value="Gentle"></option><option value="Hardy"></option>
        <option value="Hasty"></option><option value="Impish"></option><option value="Jolly"></option>
        <option value="Lax"></option><option value="Lonely"></option><option value="Mild"></option>
        <option value="Modest"></option><option value="Naive"></option><option value="Naughty"></option>
        <option value="Quiet"></option><option value="Quirky"></option><option value="Rash"></option>
        <option value="Relaxed"></option><option value="Sassy"></option><option value="Serious"></option>
        <option value="Timid"></option>
    </datalist>
    <datalist id="type-list">
        <option value="Normal"></option><option value="Fire"></option><option value="Water"></option><option value="Electric"></option>
        <option value="Grass"></option><option value="Ice"></option><option value="Fighting"></option><option value="Poison"></option>
        <option value="Ground"></option><option value="Flying"></option><option value="Psychic"></option><option value="Bug"></option>
        <option value="Rock"></option><option value="Ghost"></option><option value="Dragon"></option><option value="Dark"></option>
        <option value="Steel"></option><option value="Fairy"></option>
    </datalist>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const WORKER_BASE_URL = 'https://poke-teams-auth.srcookriss.workers.dev';
            const REGISTER_URL = `${WORKER_BASE_URL}/api/register`;
            const LOGIN_URL = `${WORKER_BASE_URL}/api/login`;

            const loginSection = document.getElementById('login-section');
            const registerSection = document.getElementById('register-section');
            const createTeamSection = document.getElementById('create-team-section');
            const mainContent = document.getElementById('main-content');

            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const createTeamForm = document.getElementById('create-team-form');
            const pokemonFormsContainer = document.getElementById('pokemon-forms-container');
            
            const loginFeedback = document.getElementById('login-feedback');
            const registerFeedback = document.getElementById('register-feedback');
            const createTeamFeedback = document.getElementById('create-team-feedback');

            const navLogoLink = document.getElementById('nav-logo-link');
            const loginNav = document.getElementById('login-nav-link');
            const registerNav = document.getElementById('register-nav-link');
            const createTeamNavLink = document.getElementById('create-team-nav-link');
            const logoutNav = document.getElementById('logout-nav-link');
            const userGreeting = document.getElementById('user-greeting');
            
            const showRegisterLink = document.getElementById('show-register-link'); 
            const showLoginLink = document.getElementById('show-login-link'); 
            const homeLink = document.getElementById('home-link'); 
            const createTeamCtaButton = document.getElementById('create-team-cta-button');
            const footerCreateTeamLink = document.getElementById('footer-create-team-link');
            const importPokepasteButton = document.getElementById('import-pokepaste-button');


            const pokemonDatalist = document.getElementById('pokemon-list');
            const itemDatalist = document.getElementById('item-list');
            const abilityDatalist = document.getElementById('ability-list');
            const moveDatalist = document.getElementById('move-list');
            
            async function populateDatalist(url, datalistElement, nameKey = 'name', processFn = (name) => name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())) {
                if (!datalistElement) return;
                try {
                    let allResults = []; let nextUrl = url;
                    // PokéAPI a veces tiene muchos resultados, iterar si es necesario
                    let count = 0; // Para evitar bucles infinitos en caso de error de API
                    while (nextUrl && count < 10) { // Limitar a 10 páginas por seguridad
                        const response = await fetch(nextUrl);
                        if (!response.ok) { console.warn(`API error for ${url} (page ${count+1}): ${response.status}`); break; }
                        const data = await response.json();
                        allResults = allResults.concat(data.results);
                        nextUrl = data.next;
                        count++;
                    }
                    allResults.sort((a, b) => a[nameKey].localeCompare(b[nameKey]));
                    allResults.forEach(item => {
                        const option = document.createElement('option');
                        option.value = processFn(item[nameKey]);
                        datalistElement.appendChild(option);
                    });
                } catch (error) { console.error(`Error populando datalist desde ${url}:`, error); }
            }

            populateDatalist('https://pokeapi.co/api/v2/pokemon?limit=1500', pokemonDatalist, 'name', name => name.charAt(0).toUpperCase() + name.slice(1).replace(/-/g, ' '));
            populateDatalist('https://pokeapi.co/api/v2/item?limit=2000', itemDatalist);
            populateDatalist('https://pokeapi.co/api/v2/ability?limit=500', abilityDatalist);
            populateDatalist('https://pokeapi.co/api/v2/move?limit=1000', moveDatalist);

            function showFeedback(element, message, isError = false) {
                if (!element) return;
                element.textContent = message;
                element.className = 'feedback-message ' + (isError ? 'error' : 'success');
                element.style.display = 'block';
                setTimeout(() => { if(element) element.style.display = 'none'; }, 5000);
            }

            function hideAllSections() {
                if (loginSection) loginSection.style.display = 'none';
                if (registerSection) registerSection.style.display = 'none';
                if (createTeamSection) createTeamSection.style.display = 'none';
                if (mainContent) mainContent.style.display = 'none';
            }

            function showLoginForm() { hideAllSections(); if (loginSection) loginSection.style.display = 'block'; }
            function showRegisterForm() { hideAllSections(); if (registerSection) registerSection.style.display = 'block'; }
            function showCreateTeamForm() {
                const user = localStorage.getItem('userData');
                if (user) { hideAllSections(); if (createTeamSection) createTeamSection.style.display = 'block'; }
                else { alert("Debes iniciar sesión para crear un equipo."); showLoginForm(); }
            }
            function showMainContent() { hideAllSections(); if (mainContent) mainContent.style.display = 'block'; }

            function updateNavForLoggedInUser(username) {
                if (loginNav) loginNav.style.display = 'none';
                if (registerNav) registerNav.style.display = 'none';
                if (createTeamNavLink) createTeamNavLink.style.display = 'list-item';
                if (logoutNav) logoutNav.style.display = 'list-item';
                if (userGreeting) { userGreeting.textContent = `Hola, ${username}`; userGreeting.style.display = 'list-item';}
                showMainContent();
            }

            function updateNavForLoggedOutUser() {
                if (loginNav) loginNav.style.display = 'list-item';
                if (registerNav) registerNav.style.display = 'list-item';
                if (createTeamNavLink) createTeamNavLink.style.display = 'none';
                if (logoutNav) logoutNav.style.display = 'none';
                if (userGreeting) userGreeting.style.display = 'none';
                showMainContent();
            }
            
            async function handleAuthSubmit(event, url, formElement, feedbackElement, isRegister = false) {
                event.preventDefault();
                const formData = new FormData(formElement);
                const data = Object.fromEntries(formData.entries());
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    const result = await response.json();
                    if (response.ok) {
                        if (isRegister) {
                            showFeedback(feedbackElement, `¡Registro exitoso! ${result.message}. Ahora puedes iniciar sesión.`, false);
                            formElement.reset(); setTimeout(showLoginForm, 2000);
                        } else {
                            showFeedback(feedbackElement, `¡Inicio de sesión exitoso! Bienvenido, ${result.user.username}.`, false);
                            formElement.reset(); localStorage.setItem('userData', JSON.stringify(result.user)); 
                            updateNavForLoggedInUser(result.user.username);
                        }
                    } else { showFeedback(feedbackElement, `Error: ${result.error || response.statusText}`, true); }
                } catch (error) { showFeedback(feedbackElement, 'Error de conexión. Intenta de nuevo.', true); }
            }

            if (registerForm) registerForm.addEventListener('submit', (e) => handleAuthSubmit(e, REGISTER_URL, registerForm, registerFeedback, true));
            if (loginForm) loginForm.addEventListener('submit', (e) => handleAuthSubmit(e, LOGIN_URL, loginForm, loginFeedback));
            if (logoutNav) logoutNav.addEventListener('click', (e) => { e.preventDefault(); localStorage.removeItem('userData'); updateNavForLoggedOutUser(); });

            if (navLogoLink) navLogoLink.addEventListener('click', (e) => { e.preventDefault(); showMainContent(); });
            if (loginNav) loginNav.addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            if (registerNav) registerNav.addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            if (createTeamNavLink) createTeamNavLink.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });
            if (showLoginLink) showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            if (showRegisterLink) showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            if (homeLink) homeLink.addEventListener('click', (e) => { e.preventDefault(); showMainContent(); });
            if (createTeamCtaButton) createTeamCtaButton.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });
            if (footerCreateTeamLink) footerCreateTeamLink.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });

            const storedUser = localStorage.getItem('userData');
            if (storedUser) {
                try { const userData = JSON.parse(storedUser); updateNavForLoggedInUser(userData.username); }
                catch (e) { localStorage.removeItem('userData'); updateNavForLoggedOutUser(); }
            } else {
                updateNavForLoggedOutUser();
            }
            
            let teamsData = {
                "equipo1": {
                    id: "equipo1", title: "Campeones de la Liga", format: "VGC 2025 Series 1", creator: "MaestroPoké",
                    description: "Este equipo se centra en un control de velocidad agresivo con Tailwind y ataques potentes.",
                    youtubeLink: "https://www.youtube.com/watch?v=dQw4w9WgXcQ", likes: 245, comments: [], saves: 189,
                    pokemons: [
                        { name: "pikachu", item: "light-ball", ability: "lightning-rod", evs: "4 HP / 252 SpA / 252 Spe", nature: "Timid", teraType: "water", moves: ["thunderbolt", "fake-out", "grass-knot", "protect"], types: ["electric"] },
                        { name: "charizard", item: "choice-specs", ability: "solar-power", evs: "252 SpA / 4 SpD / 252 Spe", nature: "Timid", teraType: "grass", moves: ["heat-wave", "solar-beam", "air-slash", "protect"], types: ["fire", "flying"] },
                        { name: "blastoise", item: "white-herb", ability: "torrent", evs: "252 HP / 252 SpA / 4 SpD", nature: "Modest", teraType: "steel", moves: ["shell-smash", "hydro-pump", "ice-beam", "protect"], types: ["water"] },
                        { name: "venusaur", item: "focus-sash", ability: "chlorophyll", evs: "4 HP / 252 SpA / 252 Spe", nature: "Modest", teraType: "fire", moves: ["sleep-powder", "leaf-storm", "sludge-bomb", "protect"], types: ["grass", "poison"] },
                        { name: "snorlax", item: "sitrus-berry", ability: "gluttony", evs: "252 HP / 252 Def / 4 SpD", nature: "Impish", teraType: "normal", moves: ["belly-drum", "body-slam", "darkest-lariat", "recycle"], types: ["normal"] },
                        { name: "dragonite", item: "lum-berry", ability: "multiscale", evs: "252 Atk / 4 Def / 252 Spe", nature: "Adamant", teraType: "flying", moves: ["dragon-dance", "dragon-claw", "extreme-speed", "iron-head"], types: ["dragon", "flying"] }
                    ]
                }
            };
            
            function renderTeamCard(team) {
                let pokemonIconsHtml = '';
                team.pokemons.slice(0, 6).forEach(p => {
                    const pokemonNameForSprite = p.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/gi, '');
                    const pokemonSpriteUrl = `https://play.pokemonshowdown.com/sprites/gen5/${pokemonNameForSprite}.png`;
                    pokemonIconsHtml += `<div class="pokemon-icon-preview"><img src="${pokemonSpriteUrl}" alt="${p.name}" onerror="this.src='https://placehold.co/60x60/cccccc/969696?text=${p.name.substring(0,1).toUpperCase()}&font=roboto'; this.alt='${p.name}'"><div class="pokemon-name-preview">${p.name.charAt(0).toUpperCase() + p.name.slice(1)}</div></div>`;
                });
                return `
                    <div class="team-card" data-team-id="${team.id}">
                        <div class="team-header"><div class="team-title">${team.title}</div><div class="team-format">${team.format}</div></div>
                        <div class="team-pokemon-preview">${pokemonIconsHtml}</div>
                        <div class="team-footer">
                            <div class="team-footer-top-row">
                                <div class="team-stats">
                                    <div class="stat">👍 ${team.likes || 0}</div> <div class="stat">💬 ${team.comments?.length || 0}</div> <div class="stat">💾 ${team.saves || 0}</div>
                                </div>
                                <div class="team-creator">Por: ${team.creator}</div>
                            </div>
                            <div class="team-actions">
                                <button class="team-action-button pokepaste-button">Copiar Pokepaste</button>
                                <button class="team-action-button view-details-button">Ver Detalles</button>
                            </div>
                        </div></div>`;
            }
            
            const teamGridDestacados = document.getElementById('team-grid-destacados');
            function renderAllTeamCards() {
                if (teamGridDestacados) {
                    teamGridDestacados.innerHTML = Object.values(teamsData).map(renderTeamCard).join('');
                    document.querySelectorAll('.view-details-button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const teamCard = event.target.closest('.team-card');
                            if (teamCard) {
                                const teamId = teamCard.dataset.teamId;
                                localStorage.setItem('currentTeamDetails', JSON.stringify(teamsData[teamId]));
                                window.open(`team_detail.html?teamId=${teamId}`, '_blank');
                            }
                        });
                    });
                    document.querySelectorAll('.pokepaste-button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const teamCard = event.target.closest('.team-card');
                            if (teamCard) {
                                const team = teamsData[teamCard.dataset.teamId];
                                if (team) {
                                    const pokepasteText = generatePokepasteStringFromTeamData(team);
                                    navigator.clipboard.writeText(pokepasteText).then(() => {
                                        alert('¡Equipo copiado a Pokepaste!\n\n' + pokepasteText);
                                    }).catch(err => { alert('Error al copiar. Revisa la consola.'); });
                                }
                            }
                        });
                    });
                }
            }
            renderAllTeamCards(); 

            function generatePokepasteStringFromTeamData(teamDetails) {
                if (!teamDetails || !teamDetails.pokemons) return "";
                let pasteString = "";
                teamDetails.pokemons.forEach(p => {
                    pasteString += `${p.name.charAt(0).toUpperCase() + p.name.slice(1)} @ ${p.item ? p.item.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Ninguno'}\n`;
                    pasteString += `Ability: ${p.ability ? p.ability.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'}\n`;
                    if (p.level) pasteString += `Level: ${p.level}\n`;
                    if (p.teraType) pasteString += `Tera Type: ${p.teraType.charAt(0).toUpperCase() + p.teraType.slice(1)}\n`;
                    pasteString += `EVs: ${p.evs}\n`;
                    pasteString += `${p.nature} Nature\n`;
                    (p.moves || []).forEach(move => { // Asegurar que p.moves exista
                        pasteString += `- ${move.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}\n`;
                    });
                    pasteString += `\n`;
                });
                return pasteString.trim();
            }

            function generatePokemonFormFields(index) {
                const evStats = ['HP', 'Atk', 'Def', 'SpA', 'SpD', 'Spe'];
                let evInputsHtml = `<label style="grid-column: 1 / -1; text-align:left; margin-bottom:0.3rem;">EVs:</label><div class="evs-grid">`;
                evStats.forEach(stat => {
                    evInputsHtml += `<div><label for="pokemon-${index}-ev-${stat.toLowerCase()}">${stat}</label><input type="number" id="pokemon-${index}-ev-${stat.toLowerCase()}" name="pokemon-${index}-ev-${stat.toLowerCase()}" min="0" max="252" value="0" class="ev-input" data-pokemon-idx="${index}"></div>`;
                });
                evInputsHtml += '</div>';
                return `
                    <div class="pokemon-form-block" data-pokemon-idx="${index}">
                        <h4>Pokémon ${index + 1}</h4>
                        <div class="form-group"><label for="pokemon-name-${index}">Nombre</label><input type="text" id="pokemon-name-${index}" name="pokemon-${index}-name" list="pokemon-list" required placeholder="Ej: Pikachu"></div>
                        <div class="form-group"><label for="pokemon-item-${index}">Objeto</label><input type="text" id="pokemon-item-${index}" name="pokemon-${index}-item" list="item-list" placeholder="Ej: Light Ball"></div>
                        <div class="form-group"><label for="pokemon-ability-${index}">Habilidad</label><input type="text" id="pokemon-ability-${index}" name="pokemon-${index}-ability" list="ability-list" placeholder="Ej: Static"></div>
                        ${evInputsHtml}
                        <div class="ev-total" id="ev-total-display-${index}">Total EVs: 0 / 508</div>
                        <div class="form-group"><label for="pokemon-nature-${index}">Naturaleza</label><input type="text" id="pokemon-nature-${index}" name="pokemon-${index}-nature" list="nature-list" placeholder="Ej: Timid"></div>
                        <div class="form-group"><label for="pokemon-teratype-${index}">Teratipo</label><input type="text" id="pokemon-teratype-${index}" name="pokemon-${index}-teraType" list="type-list" placeholder="Ej: Water"></div>
                        <label>Movimientos (4):</label><div class="moves-grid">
                            ${[0,1,2,3].map(moveIdx => `<div class="form-group"><input type="text" id="pokemon-${index}-move-${moveIdx}" name="pokemon-${index}-move${moveIdx+1}" list="move-list" placeholder="Movimiento ${moveIdx+1}" required></div>`).join('')}
                        </div></div>`;
            }

            if (pokemonFormsContainer) {
                for (let i = 0; i < 6; i++) { pokemonFormsContainer.innerHTML += generatePokemonFormFields(i); }
                document.querySelectorAll('.ev-input').forEach(input => input.addEventListener('input', handleEvInputChange));
            }
            
            function handleEvInputChange(event) {
                const targetInput = event.target; const pokemonIdx = targetInput.dataset.pokemonIdx;
                const allEvInputsForPokemon = document.querySelectorAll(`.ev-input[data-pokemon-idx="${pokemonIdx}"]`);
                let currentTotalEvs = 0;
                allEvInputsForPokemon.forEach(input => {
                    let value = parseInt(input.value) || 0; if (value < 0) value = 0; if (value > 252) value = 252;
                    input.value = value; currentTotalEvs += value;
                });
                const totalDisplay = document.getElementById(`ev-total-display-${pokemonIdx}`);
                if (totalDisplay) {
                    totalDisplay.textContent = `Total EVs: ${currentTotalEvs} / 508`;
                    totalDisplay.style.color = currentTotalEvs > 508 ? 'var(--danger)' : 'var(--dark)';
                }
                if (currentTotalEvs > 508 && createTeamFeedback) showFeedback(createTeamFeedback, `Total de EVs para Pokémon ${parseInt(pokemonIdx)+1} excede 508. (Actual: ${currentTotalEvs})`, true);
                else if (createTeamFeedback && createTeamFeedback.classList.contains('error') && createTeamFeedback.textContent.includes(`Pokémon ${parseInt(pokemonIdx)+1}`)) { createTeamFeedback.style.display = 'none'; }
            }

            if (createTeamForm) {
                createTeamForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const formData = new FormData(createTeamForm); const loggedInUser = JSON.parse(localStorage.getItem('userData'));
                    if (!loggedInUser) { showFeedback(createTeamFeedback, 'Debes iniciar sesión para guardar un equipo.', true); showLoginForm(); return; }

                    const newTeam = {
                        id: `equipo${Date.now()}`, title: formData.get('teamTitle'), format: formData.get('teamFormat'),
                        creator: loggedInUser.username, description: formData.get('teamDescription'),
                        youtubeLink: formData.get('teamYoutubeLink'), likes: 0, comments: [], saves: 0, pokemons: []
                    };
                    let globalEvError = false;
                    for (let i = 0; i < 6; i++) {
                        let pokemonEvTotal = 0; const evs = {};
                        ['hp', 'atk', 'def', 'spa', 'spd', 'spe'].forEach(stat => {
                            const evValue = parseInt(formData.get(`pokemon-${i}-ev-${stat.toLowerCase()}`)) || 0;
                            evs[stat.toUpperCase()] = evValue; pokemonEvTotal += evValue;
                        });
                        if (pokemonEvTotal > 508) { globalEvError = true; break; }
                        
                        const pokemonNameInput = formData.get(`pokemon-${i}-name`);
                        if (!pokemonNameInput || pokemonNameInput.trim() === "") { showFeedback(createTeamFeedback, `El nombre para el Pokémon ${i+1} es requerido.`, true); return; }
                        
                        const pokeApiName = pokemonNameInput.toLowerCase().replace(/\s+/g, '-'); // Normalizar para API
                        const pokeData = await fetchFromPokeAPI(`pokemon/${pokeApiName}`);
                        const pokemonTypes = pokeData && pokeData.types ? pokeData.types.map(typeInfo => typeInfo.type.name) : [];

                        newTeam.pokemons.push({
                            name: pokemonNameInput, // Guardar el nombre como lo ingresó el usuario para display
                            item: formData.get(`pokemon-${i}-item`), 
                            ability: formData.get(`pokemon-${i}-ability`),
                            evs: `${evs.HP} HP / ${evs.Atk} Atk / ${evs.Def} Def / ${evs.SpA} SpA / ${evs.SpD} SpD / ${evs.Spe} Spe`,
                            nature: formData.get(`pokemon-${i}-nature`), 
                            teraType: formData.get(`pokemon-${i}-teraType`),
                            moves: [1,2,3,4].map(mIdx => formData.get(`pokemon-${i}-move${mIdx}`)).filter(move => move && move.trim() !== ''),
                            types: pokemonTypes
                        });
                    }
                    if (globalEvError) { showFeedback(createTeamFeedback, `Uno o más Pokémon exceden el total de 508 EVs. Revisa los totales.`, true); return; }
                    if (newTeam.pokemons.length < 6) { showFeedback(createTeamFeedback, `Debes completar los 6 Pokémon del equipo.`, true); return; }

                    teamsData[newTeam.id] = newTeam; renderAllTeamCards(); 
                    showFeedback(createTeamFeedback, '¡Equipo creado y añadido a la lista (temporalmente)!', false);
                    createTeamForm.reset();
                    document.querySelectorAll('.ev-total').forEach(el => { el.textContent = 'Total EVs: 0 / 508'; el.style.color = 'var(--dark)';});
                    setTimeout(showMainContent, 2000);
                });
            }
            
            // Lógica para Importar desde Pokepaste
            if (importPokepasteButton) {
                importPokepasteButton.addEventListener('click', async () => {
                    const pokepasteLinkInput = document.getElementById('pokepaste-import-input');
                    const pasteURL = pokepasteLinkInput.value.trim();
                    if (!pasteURL) {
                        showFeedback(createTeamFeedback, "Por favor, introduce un enlace de Pokepaste.", true);
                        return;
                    }
                    // Un proxy CORS es necesario si Pokepaste.es no permite CORS directo desde tu dominio.
                    // Cloudflare Workers puede actuar como un proxy simple.
                    // Por ahora, asumimos que podemos hacer fetch directo o que el usuario maneja el CORS.
                    // Este es un ejemplo muy simplificado de parseo. Pokepaste puede tener formatos complejos.
                    try {
                        // Para evitar problemas de CORS, el usuario podría tener que pegar el contenido del paste directamente
                        // o necesitarías un proxy. Aquí simularemos la obtención del texto.
                        // En un caso real, si el fetch directo falla por CORS, informa al usuario.
                        // const response = await fetch(pasteURL); // Esto probablemente falle por CORS
                        // const pasteText = await response.text();
                        const pasteText = prompt("Debido a restricciones CORS, por favor, pega el contenido de tu Pokepaste aquí:", "");

                        if (!pasteText) {
                            showFeedback(createTeamFeedback, "No se proporcionó texto de Pokepaste.", true);
                            return;
                        }

                        const parsedPokemons = parsePokepaste(pasteText);
                        if (parsedPokemons.length > 0) {
                            fillCreateTeamForm(parsedPokemons);
                            showFeedback(createTeamFeedback, "Datos de Pokepaste importados al formulario.", false);
                        } else {
                            showFeedback(createTeamFeedback, "No se pudieron parsear datos del Pokepaste. Asegúrate de que el formato es correcto.", true);
                        }
                    } catch (error) {
                        console.error("Error importando Pokepaste:", error);
                        showFeedback(createTeamFeedback, "Error al intentar importar desde Pokepaste. Verifica el enlace o el formato.", true);
                    }
                });
            }

            function parsePokepaste(text) {
                const pokemons = [];
                const sections = text.trim().split(/\n\s*\n/); // Separar por bloques de Pokémon (doble salto de línea)
                
                sections.forEach(section => {
                    if (section.trim() === "") return;
                    const lines = section.trim().split('\n');
                    const pokemon = { name: '', item: '', ability: '', evs: '', nature: '', teraType: '', moves: [] };
                    
                    // Primera línea: Nombre @ Objeto (opcional)
                    const firstLineMatch = lines[0].match(/^(.+?)(?:\s@\s(.+))?$/);
                    if (firstLineMatch) {
                        pokemon.name = firstLineMatch[1].trim();
                        if (firstLineMatch[2]) pokemon.item = firstLineMatch[2].trim();
                    } else {
                        pokemon.name = lines[0].trim(); // Si no hay objeto
                    }

                    lines.slice(1).forEach(line => {
                        line = line.trim();
                        if (line.startsWith('Ability: ')) pokemon.ability = line.substring('Ability: '.length).trim();
                        else if (line.startsWith('EVs: ')) pokemon.evs = line.substring('EVs: '.length).trim();
                        else if (line.endsWith(' Nature')) pokemon.nature = line.replace(' Nature', '').trim();
                        else if (line.startsWith('Tera Type: ')) pokemon.teraType = line.substring('Tera Type: '.length).trim();
                        else if (line.startsWith('- ')) pokemon.moves.push(line.substring(2).trim());
                    });
                    if (pokemon.name) pokemons.push(pokemon);
                });
                return pokemons.slice(0, 6); // Tomar hasta 6 Pokémon
            }

            function fillCreateTeamForm(parsedPokemons) {
                parsedPokemons.forEach((pokemon, index) => {
                    if (index >= 6) return; // No rellenar más de 6

                    document.getElementById(`pokemon-name-${index}`).value = pokemon.name || '';
                    document.getElementById(`pokemon-item-${index}`).value = pokemon.item || '';
                    document.getElementById(`pokemon-ability-${index}`).value = pokemon.ability || '';
                    document.getElementById(`pokemon-nature-${index}`).value = pokemon.nature || '';
                    document.getElementById(`pokemon-teratype-${index}`).value = pokemon.teraType || '';

                    // Rellenar EVs (esto es más complejo de parsear y distribuir)
                    // Por ahora, lo dejamos como un string, el usuario puede ajustarlo
                    const evInput = document.querySelector(`.pokemon-form-block[data-pokemon-idx="${index}"] input[name$="-ev-hp"]`); // Un input de EV para encontrar el bloque
                    if (evInput) {
                        const evBlock = evInput.closest('.pokemon-form-block');
                        const evDisplay = evBlock.querySelector('.ev-total');
                        // No rellenamos los campos individuales de EV, solo mostramos el string
                        // El usuario tendrá que introducirlos manualmente o mejorar el parseo
                        if (evDisplay) evDisplay.textContent = `EVs Importados: ${pokemon.evs || 'N/A'}`;
                        // Limpiar los inputs individuales de EV
                        ['hp', 'atk', 'def', 'spa', 'spd', 'spe'].forEach(stat => {
                             document.getElementById(`pokemon-${index}-ev-${stat.toLowerCase()}`).value = 0;
                        });
                    }


                    (pokemon.moves || []).forEach((move, moveIdx) => {
                        if (moveIdx < 4) {
                            document.getElementById(`pokemon-${index}-move-${moveIdx}`).value = move;
                        }
                    });
                });
                 // Actualizar todos los contadores de EV a 0 después de rellenar
                document.querySelectorAll('.ev-input').forEach(input => {
                    if (!parsedPokemons.some((p, idx) => idx.toString() === input.dataset.pokemonIdx && p.evs)) { // Solo si no se importaron EVs para este poke
                         input.value = 0;
                    }
                });
                document.querySelectorAll('.ev-total').forEach((el, idx) => {
                     if (!parsedPokemons.some((p, pIdx) => pIdx === idx && p.evs)) {
                        el.textContent = 'Total EVs: 0 / 508';
                        el.style.color = 'var(--dark)';
                    }
                });
            }

        });
    </script>
</body>
</html>
