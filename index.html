<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokéTeams - Comparte y Descubre Equipos Pokémon</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... (Tu CSS completo de la v7 - sin cambios) ... */
        :root {
            --primary: #ff5350; --primary-dark: #d13330; --secondary: #3b4cca; --light: #f8f9fa;
            --dark: #343a40; --success: #30c58b; --danger: #dc3545;
            --type-normal: #A8A77A; --type-fire: #EE8130; --type-water: #6390F0; --type-electric: #F7D02C;
            --type-grass: #7AC74C; --type-ice: #96D9D6; --type-fighting: #C22E28; --type-poison: #A33EA1;
            --type-ground: #E2BF65; --type-flying: #A98FF3; --type-psychic: #F95587; --type-bug: #A6B91A;
            --type-rock: #B6A136; --type-ghost: #735797; --type-dragon: #6F35FC; --type-dark: #705746;
            --type-steel: #B7B7CE; --type-fairy: #D685AD;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #f4f4f4; color: var(--dark); line-height: 1.6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; }
        header { background-color: var(--primary); color: white; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .navbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; text-decoration: none; color: white;}
        .logo span { color: var(--secondary); }
        .nav-links { display: flex; list-style: none; flex-wrap: wrap; padding-left: 0;}
        .nav-links li { margin-left: 1rem; margin-bottom: 0.5rem; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s, background-color 0.3s; padding: 0.3rem 0.5rem; border-radius: 5px; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background-color: white; }
        
        .auth-section, #create-team-section, #advanced-search-section, #search-results-section { 
            background-color: white; padding: 2rem; margin: 2rem auto; border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 750px; 
        }
        .auth-section h2, #create-team-section h2, #advanced-search-section h2, #search-results-section h2 { 
            text-align: center; color: var(--primary); margin-bottom: 1.5rem; 
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
        .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="password"], .form-group input[type="url"], .form-group input[type="number"], .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; transition: border-color 0.3s; box-sizing: border-box; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--secondary); outline: none; }
        
        .auth-button, .submit-team-button, .action-button { background-color: var(--secondary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 25px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; display: block; width: 100%; margin-top: 1.5rem; }
        .auth-button:hover, .submit-team-button:hover, .action-button:hover { background-color: #2a3ba9; }
        .action-button { background-color: var(--success); margin-top:0.5rem; font-size:0.9rem; padding: 0.5rem 1rem;}
        .action-button.small {padding: 0.4rem 0.8rem; font-size: 0.8rem; width:auto; display: inline-block; margin-left: 0.5rem;}

        .auth-toggle-link { display: block; text-align: center; margin-top: 1.5rem; color: var(--primary); text-decoration: none; font-weight: 500; }
        .auth-toggle-link:hover { text-decoration: underline; }
        .feedback-message { padding: 0.75rem; margin-top: 1rem; border-radius: 5px; text-align: center; font-size: 0.9rem;}
        .feedback-message.success { background-color: var(--success); color: white; }
        .feedback-message.error { background-color: var(--danger); color: white; }
        
        #login-section, #register-section, #create-team-section, #advanced-search-section, #search-results-section { display: none; } 
        #user-greeting { display: none; color: white; font-weight: 500; margin-left: 1rem; align-self: center;}

        .pokemon-form-block { border: 1px solid #eee; background-color:#f9f9f9; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 8px; }
        .pokemon-form-block h4 { color: var(--secondary); margin-bottom: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; }
        .evs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.75rem; align-items: center; margin-bottom: 0.5rem;}
        .evs-grid label { font-size: 0.85rem; text-align: center;}
        .evs-grid input[type="number"] { text-align: center; padding: 0.5rem; font-size:0.9rem; }
        .ev-total { font-weight: bold; margin-top: 0.5rem; text-align: right; font-size: 0.9rem;}
        .moves-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }

        .search-bar-container { display: flex; align-items: center; justify-content: center; margin: 1rem auto; max-width: 700px;}
        .search-bar { background-color: white; border-radius: 25px; padding: 0.6rem 1rem; display: flex; align-items: center; flex-grow: 1; max-width: 600px; }
        .search-bar input { flex: 1; border: none; outline: none; font-size: 0.9rem; padding-right: 1rem; }
        .search-bar button { background-color: var(--secondary); color: white; border: none; border-radius: 20px; padding: 0.4rem 1rem; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .search-bar button:hover { background-color: #2a3ba9; }
        main.container { padding-top: 1rem; padding-bottom: 2rem; }
        .featured-section { margin: 2rem 0; }
        .section-title { font-size: 1.8rem; margin-bottom: 1.5rem; border-bottom: 3px solid var(--primary); padding-bottom: 0.5rem; display: inline-block; }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .team-card { background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; display: flex; flex-direction: column; }
        .team-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .team-header { background-color: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .team-title { font-size: 1.2rem; font-weight: bold; }
        .team-format { background-color: var(--secondary); padding: 0.3rem 0.6rem; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
        .team-pokemon-preview { display: flex; justify-content: space-around; padding: 1rem; flex-wrap: wrap; }
        .pokemon-icon-preview { text-align: center; margin: 0.25rem; width: calc(100%/3 - 1rem); max-width: 80px; }
        .pokemon-icon-preview img { width: 60px; height: 60px; object-fit: contain; border-radius: 50%; background-color: #e9e9e9; border: 1px solid #ccc; margin-bottom: 0.2rem; image-rendering: pixelated; }
        .pokemon-name-preview { font-size: 0.75rem; margin-top: 0.1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }
        .team-footer { padding: 1rem; background-color: #f8f8f8; border-top: 1px solid #eee; font-size: 0.9rem; margin-top: auto; }
        .team-footer-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap;}
        .team-stats { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .stat { display: flex; align-items: center; gap: 0.3rem; }
        .team-creator { font-weight: 500; color: var(--secondary); white-space: nowrap; }
        .team-actions { display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.5rem; }
        .team-action-button { background-color: var(--secondary); color: white; border: none; border-radius: 20px; padding: 0.5rem 1rem; cursor: pointer; font-weight: bold; transition: background-color 0.3s; font-size: 0.8rem; flex-grow: 1; text-align: center; }
        .team-action-button.view-details { background-color: var(--success); }
        .team-action-button:hover { filter: brightness(110%); }
        .cta-section { text-align: center; margin: 3rem 0; padding: 2.5rem 1rem; background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .cta-title { font-size: 2.2rem; margin-bottom: 1rem; }
        .cta-description { max-width: 600px; margin: 0 auto 1.5rem; line-height: 1.7; font-size: 1.1rem; }
        .cta-button { background-color: white; color: var(--primary); text-decoration: none; padding: 0.9rem 2.2rem; border-radius: 25px; font-weight: bold; display: inline-block; transition: all 0.3s; border: 2px solid transparent; }
        .cta-button:hover { background-color: transparent; color: white; border-color: white; transform: translateY(-3px); }
        .categories-section { margin: 2rem 0; }
        .category-list { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0; justify-content: center; }
        .category-item { background-color: white; padding: 0.8rem 1.5rem; border-radius: 25px; font-weight: 500; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd; }
        .category-item:hover, .category-item.active { background-color: var(--secondary); color: white; border-color: var(--secondary); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        footer { background-color: var(--dark); color: white; padding: 3rem 0 2rem; margin-top: 3rem; }
        .footer-content { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 2rem; margin-bottom: 2rem; }
        .footer-column { flex: 1; min-width: 220px; }
        .footer-column h3 { margin-bottom: 1.2rem; font-size: 1.3rem; color: var(--primary); }
        .footer-column p { color: #ccc; line-height: 1.7; }
        .footer-links { list-style: none; padding-left: 0; }
        .footer-links li { margin-bottom: 0.8rem; }
        .footer-links a { color: #aaa; text-decoration: none; transition: color 0.3s, padding-left 0.3s; }
        .footer-links a:hover { color: white; padding-left: 5px; }
        .footer-bottom { margin-top: 2rem; text-align: center; padding-top: 2rem; border-top: 1px solid #555; color: #aaa; font-size: 0.9rem; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="#" id="nav-logo-link" class="logo">Poké<span>Teams</span></a>
                <ul class="nav-links">
                    <li><a href="#" id="home-link" class="active">Inicio</a></li>
                    <li><a href="#" id="popular-link">Populares</a></li>
                    <li id="create-team-nav-link" style="display:none;"><a href="#">Crear Equipo</a></li>
                    <li id="login-nav-link"><a href="#">Iniciar Sesión</a></li>
                    <li id="register-nav-link"><a href="#">Registrarse</a></li>
                    <li id="logout-nav-link" style="display:none;"><a href="#">Cerrar Sesión</a></li>
                    <li id="user-greeting"></li>
                </ul>
            </div>
            <div class="search-bar-container">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="Buscar equipos por título o creador...">
                    <button id="search-button">Buscar</button>
                </div>
                <button id="toggle-advanced-search-button" class="action-button small">Avanzada</button>
            </div>
        </div>
    </header>

    <main class="container">
        <section id="advanced-search-section">
            <h2>Búsqueda Avanzada de Equipos</h2>
            <form id="advanced-search-form">
                <div class="form-group">
                    <label for="adv-search-pokemon">Contiene Pokémon:</label>
                    <input type="text" id="adv-search-pokemon" name="pokemon" list="pokemon-list-adv-search" placeholder="Nombre del Pokémon">
                </div>
                <div class="form-group">
                    <label for="adv-search-item">Contiene Objeto:</label>
                    <input type="text" id="adv-search-item" name="item" list="item-list-adv-search" placeholder="Nombre del objeto">
                </div>
                <div class="form-group">
                    <label for="adv-search-move">Contiene Movimiento:</label>
                    <input type="text" id="adv-search-move" name="move" list="move-list-adv-search" placeholder="Nombre del movimiento">
                </div>
                <div class="form-group">
                    <label for="adv-search-format">Formato Específico:</label>
                    <select id="adv-search-format" name="format">
                        <option value="">Cualquier Formato</option>
                    </select>
                </div>
                <button type="submit" class="action-button" style="width:100%; background-color: var(--primary);">Buscar Equipos</button>
            </form>
            <div id="advanced-search-feedback" class="feedback-message" style="display:none;"></div>
        </section>

        <section id="login-section" class="auth-section">
            <h2>Iniciar Sesión</h2>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" name="email" required></div>
                <div class="form-group"><label for="login-password">Contraseña</label><input type="password" id="login-password" name="password" required></div>
                <button type="submit" class="auth-button">Entrar</button>
            </form>
            <div id="login-feedback" class="feedback-message" style="display:none;"></div>
            <a href="#" id="show-register-link" class="auth-toggle-link">¿No tienes cuenta? Regístrate</a>
        </section>

        <section id="register-section" class="auth-section">
            <h2>Crear Cuenta</h2>
            <form id="register-form">
                <div class="form-group"><label for="register-username">Nombre de Usuario</label><input type="text" id="register-username" name="username" required></div>
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" name="email" required></div>
                <div class="form-group"><label for="register-password">Contraseña (mín. 6 caracteres)</label><input type="password" id="register-password" name="password" required minlength="6"></div>
                <button type="submit" class="auth-button">Registrarse</button>
            </form>
            <div id="register-feedback" class="feedback-message" style="display:none;"></div>
            <a href="#" id="show-login-link" class="auth-toggle-link">¿Ya tienes cuenta? Inicia Sesión</a>
        </section>

        <section id="create-team-section">
            <h2>Crear Nuevo Equipo Pokémon</h2>
            <form id="create-team-form">
                <div class="form-group">
                    <label for="team-title-input">Título del Equipo</label>
                    <input type="text" id="team-title-input" name="teamTitle" required>
                </div>
                <div class="form-group">
                    <label for="team-format-input">Formato de Competición</label>
                    <select id="team-format-input" name="teamFormat" required>
                        <option value="">Selecciona un formato...</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="pokepaste-import-text">Importar desde Pokepaste (Pegar Texto)</label>
                    <textarea id="pokepaste-import-text" name="pokepasteImportText" rows="8" placeholder="Pega aquí el texto completo de tu Pokepaste..."></textarea>
                    <button type="button" id="import-pokepaste-button" class="action-button">Importar Datos de Pokepaste</button>
                </div>
                <div class="form-group">
                    <label for="team-description-input">Descripción / Guía del Equipo</label>
                    <textarea id="team-description-input" name="teamDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="team-youtube-input">Enlace de YouTube (Opcional)</label>
                    <input type="url" id="team-youtube-input" name="teamYoutubeLink" placeholder="https://www.youtube.com/watch?v=...">
                </div>
                <h3 style="color: var(--secondary); margin-top: 2rem; margin-bottom: 1rem;">Pokémon del Equipo (6)</h3>
                <p style="font-size:0.85em; margin-bottom:1rem; color: #555;">Usa las listas desplegables para seleccionar Pokémon, objetos, etc. Los campos "Buscar por Movimiento/Habilidad" son para referencia y no filtran la lista de Pokémon activamente en esta versión.</p>
                <div id="pokemon-forms-container"></div>
                <button type="submit" class="submit-team-button">Guardar Equipo</button>
            </form>
            <div id="create-team-feedback" class="feedback-message" style="display:none;"></div>
        </section>

        <section id="search-results-section" style="display: none;">
            <h2 id="search-results-title" class="section-title">Resultados de la Búsqueda</h2>
            <div class="team-grid" id="team-grid-search-results">
                </div>
        </section>

        <div id="main-content">
            <section class="featured-section">
                <h2 class="section-title">Equipos Destacados</h2>
                <div class="team-grid" id="team-grid-destacados"></div>
            </section>
            <section class="cta-section">
                <h2 class="cta-title">Crea y Comparte Tu Propio Equipo</h2>
                <p class="cta-description">¿Tienes una combinación ganadora? Compártela con la comunidad.</p>
                <a href="#" id="create-team-cta-button" class="cta-button">Crear Equipo</a>
            </section>
            <section class="categories-section">
                <h2 class="section-title">Explorar por Formato</h2>
                <div class="category-list">
                    <div class="category-item active">Todos</div><div class="category-item">VGC 2025</div><div class="category-item">OU Singles</div>
                    <div class="category-item">UU Singles</div> <div class="category-item">Doubles</div> <div class="category-item">Monotype</div>
                </div>
            </section>
            <section class="featured-section">
                <h2 class="section-title">Equipos Populares</h2>
                <div class="team-grid" id="team-grid-populares"><p style="grid-column: 1 / -1; text-align: center;">Más equipos populares próximamente...</p></div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column"><h3>Poké<span>Teams</span></h3><p>La comunidad para compartir equipos Pokémon.</p></div>
                <div class="footer-column"><h3>Enlaces</h3><ul class="footer-links"><li><a href="#">Inicio</a></li><li><a href="#" id="footer-create-team-link">Crear Equipo</a></li><li><a href="#">Guías</a></li></ul></div>
                <div class="footer-column"><h3>Recursos</h3><ul class="footer-links"><li><a href="#">Base de Datos Pokémon</a></li><li><a href="#">Calculadora</a></li></ul></div>
                <div class="footer-column"><h3>Información</h3><ul class="footer-links"><li><a href="#">Acerca de</a></li><li><a href="#">Privacidad</a></li></ul></div>
            </div>
            <div class="footer-bottom"><p>© 2025 PokéTeams. Pokémon y sus personajes son marcas de Nintendo.</p></div>
        </div>
    </footer>

    <datalist id="pokemon-list"></datalist> <datalist id="pokemon-list-adv-search"></datalist>
    <datalist id="item-list"></datalist> <datalist id="item-list-adv-search"></datalist>
    <datalist id="ability-list"></datalist>
    <datalist id="move-list"></datalist> <datalist id="move-list-adv-search"></datalist>
    <datalist id="nature-list">
        <option value="Adamant"></option><option value="Bashful"></option><option value="Bold"></option><option value="Brave"></option><option value="Calm"></option><option value="Careful"></option><option value="Docile"></option><option value="Gentle"></option><option value="Hardy"></option><option value="Hasty"></option><option value="Impish"></option><option value="Jolly"></option><option value="Lax"></option><option value="Lonely"></option><option value="Mild"></option><option value="Modest"></option><option value="Naive"></option><option value="Naughty"></option><option value="Quiet"></option><option value="Quirky"></option><option value="Rash"></option><option value="Relaxed"></option><option value="Sassy"></option><option value="Serious"></option><option value="Timid"></option>
    </datalist>
    <datalist id="type-list">
        <option value="Normal"></option><option value="Fire"></option><option value="Water"></option><option value="Electric"></option><option value="Grass"></option><option value="Ice"></option><option value="Fighting"></option><option value="Poison"></option><option value="Ground"></option><option value="Flying"></option><option value="Psychic"></option><option value="Bug"></option><option value="Rock"></option><option value="Ghost"></option><option value="Dragon"></option><option value="Dark"></option><option value="Steel"></option><option value="Fairy"></option>
    </datalist>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const WORKER_BASE_URL = 'https://poke-teams-auth.srcookriss.workers.dev';
            const REGISTER_URL = `${WORKER_BASE_URL}/api/register`;
            const LOGIN_URL = `${WORKER_BASE_URL}/api/login`;
            const CREATE_TEAM_URL = `${WORKER_BASE_URL}/api/teams`; // Para POST
            const GET_TEAMS_URL = `${WORKER_BASE_URL}/api/teams`;   // Para GET

            // Selectores principales
            const loginSection = document.getElementById('login-section');
            const registerSection = document.getElementById('register-section');
            const createTeamSection = document.getElementById('create-team-section');
            const advancedSearchSection = document.getElementById('advanced-search-section');
            const searchResultsSection = document.getElementById('search-results-section');
            const mainContent = document.getElementById('main-content'); 

            // Formularios
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const createTeamForm = document.getElementById('create-team-form');
            const advancedSearchForm = document.getElementById('advanced-search-form');
            const pokemonFormsContainer = document.getElementById('pokemon-forms-container');
            
            // Feedback
            const loginFeedback = document.getElementById('login-feedback');
            const registerFeedback = document.getElementById('register-feedback');
            const createTeamFeedback = document.getElementById('create-team-feedback');
            const advancedSearchFeedback = document.getElementById('advanced-search-feedback');

            // Navegación
            const navLogoLink = document.getElementById('nav-logo-link');
            const loginNav = document.getElementById('login-nav-link');
            const registerNav = document.getElementById('register-nav-link');
            const createTeamNavLink = document.getElementById('create-team-nav-link');
            const logoutNav = document.getElementById('logout-nav-link');
            const userGreeting = document.getElementById('user-greeting');
            const homeLink = document.getElementById('home-link'); 
            
            // Enlaces y botones de acción
            const showRegisterLink = document.getElementById('show-register-link'); 
            const showLoginLink = document.getElementById('show-login-link'); 
            const createTeamCtaButton = document.getElementById('create-team-cta-button');
            const footerCreateTeamLink = document.getElementById('footer-create-team-link');
            const importPokepasteButton = document.getElementById('import-pokepaste-button');
            const toggleAdvancedSearchButton = document.getElementById('toggle-advanced-search-button');
            const mainSearchButton = document.getElementById('search-button');
            const mainSearchInput = document.getElementById('search-input');

            // Datalists
            const pokemonDatalist = document.getElementById('pokemon-list');
            const pokemonDatalistAdv = document.getElementById('pokemon-list-adv-search');
            const itemDatalist = document.getElementById('item-list');
            const itemDatalistAdv = document.getElementById('item-list-adv-search');
            const abilityDatalist = document.getElementById('ability-list');
            const moveDatalist = document.getElementById('move-list');
            const moveDatalistAdv = document.getElementById('move-list-adv-search');
            const advSearchFormatSelect = document.getElementById('adv-search-format');
            const teamFormatSelect = document.getElementById('team-format-input');

            // ----- Carga de Datalists (PokéAPI) -----
            async function populateDatalist(url, datalistElement, nameKey = 'name', processFn = (name) => name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())) {
                if (!datalistElement) return;
                try {
                    let allResults = []; let nextUrl = url; let count = 0;
                    while (nextUrl && count < 20) { // Aumentado límite de páginas para Pokémon
                        const response = await fetch(nextUrl);
                        if (!response.ok) { console.warn(`API error for ${url} (page ${count+1}): ${response.status}`); break; }
                        const data = await response.json();
                        allResults = allResults.concat(data.results);
                        nextUrl = data.next; count++;
                    }
                    allResults.sort((a, b) => a[nameKey].localeCompare(b[nameKey]));
                    // Limpiar datalist antes de poblar, excepto si es una lista predefinida
                    if (!datalistElement.querySelector('option[value="' + processFn(allResults[0]?.[nameKey] || '') + '"]')) { // Evitar duplicados si se llama varias veces
                        datalistElement.innerHTML = '';
                    }
                    allResults.forEach(item => {
                        const option = document.createElement('option');
                        option.value = processFn(item[nameKey]);
                        datalistElement.appendChild(option);
                    });
                } catch (error) { console.error(`Error populando datalist desde ${url}:`, error); }
            }

            const pokemonNameProcessor = name => name.charAt(0).toUpperCase() + name.slice(1).replace(/-/g, ' ');
            populateDatalist('https://pokeapi.co/api/v2/pokemon?limit=10000', pokemonDatalist, 'name', pokemonNameProcessor);
            populateDatalist('https://pokeapi.co/api/v2/pokemon?limit=10000', pokemonDatalistAdv, 'name', pokemonNameProcessor);
            populateDatalist('https://pokeapi.co/api/v2/item?limit=2000', itemDatalist);
            populateDatalist('https://pokeapi.co/api/v2/item?limit=2000', itemDatalistAdv);
            populateDatalist('https://pokeapi.co/api/v2/ability?limit=500', abilityDatalist);
            populateDatalist('https://pokeapi.co/api/v2/move?limit=1000', moveDatalist);
            populateDatalist('https://pokeapi.co/api/v2/move?limit=1000', moveDatalistAdv);

            const formats = ["VGC 2025 Series 1", "VGC 2024 Regulation G", "OU (OverUsed) Singles", "UU (UnderUsed) Singles", "RU (RarelyUsed) Singles", "NU (NeverUsed) Singles", "PU (PartiallyUsed) Singles", "LC (Little Cup)", "Doubles OU", "Monotype", "Battle Stadium Singles (BSS)", "Battle Stadium Doubles (BSD)", "Anything Goes (AG)", "Custom Game", "Other"];
            [advSearchFormatSelect, teamFormatSelect].forEach(selectElement => {
                if (selectElement) {
                    const firstOptionValue = selectElement.options[0]?.value; // Guardar la primera opción (ej. "Cualquier formato")
                    selectElement.innerHTML = ''; // Limpiar
                    if (firstOptionValue !== undefined) { // Volver a añadir la primera opción si existía
                        const firstOpt = document.createElement('option');
                        firstOpt.value = firstOptionValue;
                        firstOpt.textContent = firstOptionValue || "Selecciona un formato...";
                        selectElement.appendChild(firstOpt);
                    }
                    formats.forEach(format => {
                        const option = document.createElement('option');
                        option.value = format; option.textContent = format;
                        selectElement.appendChild(option);
                    });
                }
            });

            // ----- Funciones de UI -----
            function showFeedback(element, message, isError = false) { /* ... */ }
            function hideAllPageSections() { /* ... */ }
            function showLoginForm() { /* ... */ }
            function showRegisterForm() { /* ... */ }
            function showCreateTeamForm() { /* ... */ }
            function showAdvancedSearchForm() { /* ... */ }
            function showMainContentPage() { /* ... */ }
            function showSearchResults(teams, queryDescription) { /* ... */ }
            function updateNavForLoggedInUser(username) { /* ... */ }
            function updateNavForLoggedOutUser() { /* ... */ }
            
            // ----- Lógica de Autenticación -----
            async function handleAuthSubmit(event, url, formElement, feedbackElement, isRegister = false) { /* ... */ }
            if (registerForm) registerForm.addEventListener('submit', (e) => handleAuthSubmit(e, REGISTER_URL, registerForm, registerFeedback, true));
            if (loginForm) loginForm.addEventListener('submit', (e) => handleAuthSubmit(e, LOGIN_URL, loginForm, loginFeedback));
            if (logoutNav) logoutNav.addEventListener('click', (e) => { e.preventDefault(); localStorage.removeItem('userData'); updateNavForLoggedOutUser(); });

            // ----- Manejo de Navegación -----
            if (navLogoLink) navLogoLink.addEventListener('click', (e) => { e.preventDefault(); showMainContentPage(); });
            if (loginNav) loginNav.addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            if (registerNav) registerNav.addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            if (createTeamNavLink) createTeamNavLink.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });
            if (showLoginLink) showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            if (showRegisterLink) showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            if (homeLink) homeLink.addEventListener('click', (e) => { e.preventDefault(); showMainContentPage(); });
            if (createTeamCtaButton) createTeamCtaButton.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });
            if (footerCreateTeamLink) footerCreateTeamLink.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });
            if (toggleAdvancedSearchButton) toggleAdvancedSearchButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (advancedSearchSection.style.display === 'none' || advancedSearchSection.style.display === '') {
                    showAdvancedSearchForm();
                } else {
                    showMainContentPage();
                }
            });

            // ----- Datos de Equipos y Renderizado -----
            let teamsData = {}; // Los equipos se cargarán desde el backend

            async function fetchTeamsFromBackend() {
                try {
                    const response = await fetch(GET_TEAMS_URL);
                    if (!response.ok) {
                        console.error("Error fetching teams:", response.statusText);
                        return {}; // Devuelve objeto vacío en caso de error
                    }
                    const data = await response.json();
                    const teamsObject = {};
                    // El backend devuelve un array 'teams', convertirlo a objeto como lo usábamos antes
                    if (data.teams && Array.isArray(data.teams)) {
                        data.teams.forEach(team => {
                            teamsObject[team.id] = team;
                        });
                    }
                    return teamsObject;
                } catch (error) {
                    console.error("Error fetching teams from backend:", error);
                    return {}; // Devuelve objeto vacío
                }
            }
            
            function renderTeamCard(team) { /* ... (tu función de v5, asegúrate que usa team.pokemons) ... */ return '';}
            const teamGridDestacados = document.getElementById('team-grid-destacados');
            const teamGridSearchResults = document.getElementById('team-grid-search-results');

            async function renderAllTeamCards(filteredTeams = null, targetGridId = 'team-grid-destacados') {
                const teamsToRender = filteredTeams || Object.values(teamsData); // Usa teamsData global
                const targetGridElement = document.getElementById(targetGridId);

                if (targetGridElement) {
                    if (teamsToRender.length === 0 && targetGridId === 'team-grid-destacados' && !filteredTeams) {
                         targetGridElement.innerHTML = "<p style='grid-column: 1 / -1; text-align: center;'>Cargando equipos...</p>";
                         // No hacer nada más aquí si es la carga inicial y no hay equipos aún
                         return;
                    }

                    targetGridElement.innerHTML = teamsToRender.map(renderTeamCard).join('');
                    if (teamsToRender.length === 0 && targetGridId === 'team-grid-search-results') {
                        targetGridElement.innerHTML = "<p style='grid-column: 1 / -1; text-align: center;'>No se encontraron equipos con esos criterios.</p>";
                    } else if (teamsToRender.length === 0 && targetGridId === 'team-grid-destacados') {
                         targetGridElement.innerHTML = "<p style='grid-column: 1 / -1; text-align: center;'>No hay equipos destacados. ¡Crea uno!</p>";
                    }
                    
                    targetGridElement.querySelectorAll('.view-details-button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const teamCard = event.target.closest('.team-card');
                            if (teamCard) {
                                const teamId = teamCard.dataset.teamId;
                                // Guardar el equipo completo en localStorage para team_detail.html
                                if (teamsData[teamId]) {
                                    localStorage.setItem('currentTeamDetails', JSON.stringify(teamsData[teamId]));
                                    window.open(`team_detail.html?teamId=${teamId}`, '_blank');
                                } else {
                                    console.error("No se encontraron datos para el equipo ID:", teamId, "en teamsData global.");
                                    alert("Error: No se pudieron cargar los detalles del equipo.");
                                }
                            }
                        });
                    });
                    targetGridElement.querySelectorAll('.pokepaste-button').forEach(button => { /* ... */ });
                }
            }
            
            async function initializePage() {
                const storedUserData = localStorage.getItem('userData');
                if (storedUserData) {
                    try { const userData = JSON.parse(storedUserData); updateNavForLoggedInUser(userData.username); }
                    catch (e) { localStorage.removeItem('userData'); updateNavForLoggedOutUser(); }
                } else {
                    updateNavForLoggedOutUser();
                }
                teamsData = await fetchTeamsFromBackend(); // Cargar equipos desde el backend
                localStorage.setItem('allTeamsData', JSON.stringify(teamsData)); // Guardar para team_detail.html
                renderAllTeamCards(); // Renderizar después de cargar
            }
            initializePage();


            function generatePokepasteStringFromTeamData(teamDetails) { /* ... (tu función de v5) ... */ return ""; }

            // ----- Lógica para Crear Equipo -----
            function generatePokemonFormFields(index) { /* ... (tu función de v5, con los nuevos inputs para buscar por habilidad/movimiento) ... */ return '';}
            if (pokemonFormsContainer) { /* ... (generar forms y listeners EV) ... */ }
            function handleEvInputChange(event) { /* ... (tu lógica de v5) ... */ }

            if (createTeamForm) {
                createTeamForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const formData = new FormData(createTeamForm); 
                    const loggedInUser = JSON.parse(localStorage.getItem('userData'));
                    if (!loggedInUser) { showFeedback(createTeamFeedback, 'Debes iniciar sesión para guardar un equipo.', true); showLoginForm(); return; }

                    const teamPayload = {
                        userId: loggedInUser.id, // IMPORTANTE: Enviar el ID del usuario
                        title: formData.get('teamTitle'),
                        format: formData.get('teamFormat'),
                        description: formData.get('teamDescription'),
                        youtubeLink: formData.get('teamYoutubeLink'),
                        pokemons: []
                    };

                    let globalEvError = false;
                    for (let i = 0; i < 6; i++) {
                        const pokemonNameInput = formData.get(`pokemon-${i}-name`);
                        if (pokemonNameInput && pokemonNameInput.trim() !== "") { // Solo procesar si hay nombre
                            let pokemonEvTotal = 0; const evs = {};
                            ['hp', 'atk', 'def', 'spa', 'spd', 'spe'].forEach(stat => {
                                const evValue = parseInt(formData.get(`pokemon-${i}-ev-${stat.toLowerCase()}`)) || 0;
                                evs[stat.toUpperCase()] = evValue; pokemonEvTotal += evValue;
                            });
                            if (pokemonEvTotal > 508) { globalEvError = true; break; }
                            
                            const pokeApiName = pokemonNameInput.toLowerCase().replace(/\s+/g, '-');
                            // Es buena idea obtener los tipos aquí si no se van a re-obtener en el backend
                            // Para simplificar, asumimos que el backend podría manejar esto o que se envían desde el form si hay un campo de tipos
                            // const pokeData = await fetchFromPokeAPI(`pokemon/${pokeApiName}`);
                            // const pokemonTypes = pokeData && pokeData.types ? pokeData.types.map(typeInfo => typeInfo.type.name) : [];

                            teamPayload.pokemons.push({
                                name: pokemonNameInput, 
                                item: formData.get(`pokemon-${i}-item`), 
                                ability: formData.get(`pokemon-${i}-ability`),
                                evs: `${evs.HP} HP / ${evs.Atk} Atk / ${evs.Def} Def / ${evs.SpA} SpA / ${evs.SpD} SpD / ${evs.Spe} Spe`,
                                nature: formData.get(`pokemon-${i}-nature`), 
                                teraType: formData.get(`pokemon-${i}-teraType`),
                                moves: [1,2,3,4].map(mIdx => formData.get(`pokemon-${i}-move${mIdx}`)).filter(move => move && move.trim() !== ''),
                                types: [] // Dejar vacío, el backend podría poblarlo o se obtiene al ver detalles.
                            });
                        }
                    }

                    if (globalEvError) { showFeedback(createTeamFeedback, `Uno o más Pokémon exceden el total de 508 EVs.`, true); return; }
                    if (teamPayload.pokemons.length === 0) { showFeedback(createTeamFeedback, `Debes añadir al menos un Pokémon.`, true); return; }

                    try {
                        const response = await fetch(CREATE_TEAM_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(teamPayload)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            showFeedback(createTeamFeedback, `¡Equipo "${result.title || teamPayload.title}" guardado exitosamente!`, false);
                            createTeamForm.reset();
                            document.querySelectorAll('.ev-total').forEach(el => { el.textContent = 'Total EVs: 0 / 508'; el.style.color = 'var(--dark)';});
                            teamsData = await fetchTeamsFromBackend(); // Recargar equipos
                            localStorage.setItem('allTeamsData', JSON.stringify(teamsData));
                            renderAllTeamCards();
                            setTimeout(showMainContentPage, 2000);
                        } else {
                            showFeedback(createTeamFeedback, `Error al guardar equipo: ${result.error || response.statusText}`, true);
                        }
                    } catch (error) {
                        console.error("Error al enviar equipo al backend:", error);
                        showFeedback(createTeamFeedback, 'Error de conexión al guardar el equipo.', true);
                    }
                });
            }
            
            // Lógica para Importar desde Pokepaste Texto
            if (importPokepasteButton) { /* ... (tu lógica de v6, sin cambios) ... */ }
            function parsePokepaste(text) { /* ... (tu lógica de v6, sin cambios) ... */ return [];}
            function fillCreateTeamForm(parsedPokemons) { /* ... (tu lógica de v6, sin cambios) ... */ }
            function parseEVsFromPokepasteString(evString) { /* ... (tu lógica de v6) ... */ return {};}

            // Lógica para Búsqueda Principal y Avanzada
            function performSearch(filters, queryDescription) { /* ... (tu lógica de v6, pero usa el teamsData cargado del backend) ... */ }
            if(mainSearchButton && mainSearchInput) { /* ... (tu lógica de v6) ... */ }
            if (advancedSearchForm) { /* ... (tu lógica de v6) ... */ }
            
        });
    </script>
</body>
</html>
