<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokéTeams - Share & Discover Pokémon Teams</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #ff5350; --primary-dark: #d13330; --secondary: #3b4cca; --light: #f8f9fa;
            --dark: #343a40; --success: #30c58b; --danger: #dc3545; --info: #17a2b8;
            --type-normal: #A8A77A; --type-fire: #EE8130; --type-water: #6390F0; --type-electric: #F7D02C;
            --type-grass: #7AC74C; --type-ice: #96D9D6; --type-fighting: #C22E28; --type-poison: #A33EA1;
            --type-ground: #E2BF65; --type-flying: #A98FF3; --type-psychic: #F95587; --type-bug: #A6B91A;
            --type-rock: #B6A136; --type-ghost: #735797; --type-dragon: #6F35FC; --type-dark: #705746;
            --type-steel: #B7B7CE; --type-fairy: #D685AD;
            --font-sans: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 10px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #f0f2f5; color: var(--dark); line-height: 1.6; font-family: var(--font-sans); }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; }
        header { background-color: var(--primary); color: white; padding: 1rem 0; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 1000; }
        .navbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; text-decoration: none; color: white; cursor:pointer;}
        .logo span { color: var(--secondary); }
        .nav-links { display: flex; list-style: none; flex-wrap: wrap; padding-left: 0; align-items: center;}
        .nav-links li { margin-left: 1rem; margin-bottom: 0.5rem; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; transition: color 0.2s, background-color 0.2s; padding: 0.4rem 0.8rem; border-radius: var(--border-radius); }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background-color: white; }
        
        .auth-section, #create-team-section, #advanced-search-section, #search-results-section { 
            background-color: white; padding: 2rem; margin: 2rem auto; border-radius: var(--border-radius); 
            box-shadow: var(--shadow-md); max-width: 750px; 
        }
        .auth-section h2, #create-team-section h2, #advanced-search-section h2, #search-results-section h2 { 
            text-align: center; color: var(--primary); margin-bottom: 1.5rem; 
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
        .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="password"], .form-group input[type="url"], .form-group input[type="number"], .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s; box-sizing: border-box; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 0 2px rgba(59, 76, 202, 0.2); }
        
        .auth-button, .submit-team-button, .action-button { background-color: var(--secondary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 25px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: background-color 0.3s, transform 0.1s; display: block; width: 100%; margin-top: 1.5rem; }
        .auth-button:hover, .submit-team-button:hover, .action-button:hover { background-color: #2a3ba9; transform: translateY(-1px); }
        .action-button { background-color: var(--success); margin-top:0.5rem; font-size:0.9rem; padding: 0.5rem 1rem;}
        .action-button.small {padding: 0.4rem 0.8rem; font-size: 0.8rem; width:auto; display: inline-block; margin-left: 0.5rem;}
        .action-button.danger { background-color: var(--danger); }
        .action-button.danger:hover { background-color: var(--primary-dark); }


        .auth-toggle-link { display: block; text-align: center; margin-top: 1.5rem; color: var(--primary); text-decoration: none; font-weight: 500; cursor:pointer; }
        .auth-toggle-link:hover { text-decoration: underline; }
        .feedback-message { padding: 0.75rem; margin-top: 1rem; border-radius: var(--border-radius); text-align: center; font-size: 0.9rem;}
        .feedback-message.success { background-color: var(--success); color: white; }
        .feedback-message.error { background-color: var(--danger); color: white; }
        
        #login-section, #register-section, #create-team-section, #advanced-search-section, #search-results-section { display: none; } 
        
        .user-menu-container { position: relative; }
        #user-greeting { 
            cursor: pointer; padding: 0.4rem 0.8rem; border-radius: var(--border-radius); 
            transition: background-color 0.2s; color:white; font-weight:500;
            display: inline-block; 
        }
        #user-greeting:hover { background-color: rgba(255,255,255,0.15); }
        .user-dropdown {
            display: none; position: absolute; top: calc(100% + 0.5rem); right: 0;
            background-color: white; color: var(--dark);
            border: 1px solid #ddd; border-radius: var(--border-radius); box-shadow: var(--shadow-md);
            min-width: 220px; z-index: 1001; overflow: hidden;
        }
        .user-dropdown a { display: block; padding: 0.8rem 1.2rem; text-decoration: none; color: var(--dark); font-size: 0.95rem;}
        .user-dropdown a:hover { background-color: #f0f2f5; }


        .pokemon-form-block { border: 1px solid #e0e0e0; background-color:#fdfdff; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        .pokemon-form-block h4 { color: var(--secondary); margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        .evs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;}
        .evs-grid label { font-size: 0.8rem; text-align: center; color: #555;}
        .evs-grid input[type="number"] { text-align: center; padding: 0.5rem; font-size:0.9rem; }
        .ev-total { font-weight: bold; margin-top: 0.5rem; text-align: right; font-size: 0.9rem; color: #333;}
        .moves-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .tag-checkbox { display: flex; align-items: center; background-color: #f0f2f5; padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.85rem; cursor:pointer; border: 1px solid #ddd;}
        .tag-checkbox input[type="checkbox"] { margin-right: 0.4rem; }
        .tag-checkbox:hover { background-color: #e2e6ea; }


        .search-bar-container { display: flex; align-items: center; justify-content: center; margin: 1rem auto; max-width: 700px;}
        .search-bar { background-color: white; border-radius: 25px; padding: 0.6rem 1rem; display: flex; align-items: center; flex-grow: 1; max-width: 600px; box-shadow: var(--shadow-sm); }
        .search-bar input { flex: 1; border: none; outline: none; font-size: 0.9rem; padding-right: 1rem; }
        .search-bar button { background-color: var(--secondary); color: white; border: none; border-radius: 20px; padding: 0.4rem 1rem; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .search-bar button:hover { background-color: #2a3ba9; }
        main.container { padding-top: 1rem; padding-bottom: 2rem; }
        .featured-section { margin: 2rem 0; } 
        .section-title { font-size: 1.8rem; margin-bottom: 1.5rem; border-bottom: 3px solid var(--primary); padding-bottom: 0.5rem; display: inline-block; }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .team-card { background-color: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); transition: transform 0.3s, box-shadow 0.3s; display: flex; flex-direction: column; }
        .team-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .team-header { background-color: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .team-title { font-size: 1.2rem; font-weight: bold; }
        .team-format { background-color: var(--secondary); padding: 0.3rem 0.6rem; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
        .team-pokemon-preview { display: flex; justify-content: space-around; padding: 1rem; flex-wrap: wrap; }
        .pokemon-icon-preview { text-align: center; margin: 0.25rem; width: calc(100%/3 - 1rem); max-width: 80px; }
        .pokemon-icon-preview img { width: 60px; height: 60px; object-fit: contain; border-radius: 50%; background-color: #e9e9e9; border: 1px solid #ccc; margin-bottom: 0.2rem; image-rendering: pixelated; }
        .pokemon-name-preview { font-size: 0.75rem; margin-top: 0.1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }
        .team-footer { padding: 1rem; background-color: #f8f8f8; border-top: 1px solid #eee; font-size: 0.9rem; margin-top: auto; }
        .team-footer-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap;}
        .team-stats { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .stat { display: flex; align-items: center; gap: 0.3rem; cursor: default; } 
        .like-stat.can-like { cursor: pointer; } 
        .team-creator { font-weight: 500; color: var(--secondary); white-space: nowrap; }
        .team-actions { display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.5rem; flex-wrap: wrap; } 
        .team-action-button { background-color: var(--secondary); color: white; border: none; border-radius: 20px; padding: 0.5rem 1rem; cursor: pointer; font-weight: bold; transition: background-color 0.3s; font-size: 0.8rem; flex-grow: 1; text-align: center; margin-bottom: 0.3rem; } 
        .team-action-button.view-details { background-color: var(--success); }
        .team-action-button.like-team-button { background-color: #6c757d; color: white; } 
        .team-action-button.like-team-button.liked { background-color: var(--primary); } 
        /* Edit button is removed from index.html cards */
        .team-action-button.delete-team-button { background-color: var(--danger); }
        .team-action-button:hover { filter: brightness(110%); }
        .cta-section { text-align: center; margin: 3rem 0; padding: 2.5rem 1rem; background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border-radius: var(--border-radius); box-shadow: var(--shadow-md); }
        .cta-title { font-size: 2.2rem; margin-bottom: 1rem; }
        .cta-description { max-width: 600px; margin: 0 auto 1.5rem; line-height: 1.7; font-size: 1.1rem; }
        .cta-button { background-color: white; color: var(--primary); text-decoration: none; padding: 0.9rem 2.2rem; border-radius: 25px; font-weight: bold; display: inline-block; transition: all 0.3s; border: 2px solid transparent; }
        .cta-button:hover { background-color: transparent; color: white; border-color: white; transform: translateY(-3px); }
        .categories-section { margin: 2rem 0; }
        .category-list { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0; justify-content: center; }
        .category-item { background-color: white; padding: 0.8rem 1.5rem; border-radius: 25px; font-weight: 500; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow-sm); border: 1px solid #ddd; }
        .category-item:hover, .category-item.active { background-color: var(--secondary); color: white; border-color: var(--secondary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        footer { background-color: var(--dark); color: white; padding: 3rem 0 2rem; margin-top: 3rem; }
        .footer-content { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 2rem; margin-bottom: 2rem; }
        .footer-column { flex: 1; min-width: 220px; }
        .footer-column h3 { margin-bottom: 1.2rem; font-size: 1.3rem; color: var(--primary); }
        .footer-column p { color: #ccc; line-height: 1.7; }
        .footer-links { list-style: none; padding-left: 0; }
        .footer-links li { margin-bottom: 0.8rem; }
        .footer-links a { color: #aaa; text-decoration: none; transition: color 0.3s, padding-left 0.3s; }
        .footer-links a:hover { color: white; padding-left: 5px; }
        .footer-bottom { margin-top: 2rem; text-align: center; padding-top: 2rem; border-top: 1px solid #555; color: #aaa; font-size: 0.9rem; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="#" id="nav-logo-link" class="logo">Poké<span>Teams</span></a>
                <ul class="nav-links">
                    <li><a href="#" id="home-link" class="active">Home</a></li>
                    <li id="create-team-nav-link" style="display:none;"><a href="#">Create Team</a></li>
                    <li id="login-nav-link"><a href="#">Login</a></li>
                    <li id="register-nav-link"><a href="#">Register</a></li>
                    <li id="user-menu-container" class="user-menu-container" style="display:none;">
                        <a href="#" id="user-greeting"></a>
                        <div class="user-dropdown" id="user-dropdown-menu">
                            <a href="my_teams.html" id="my-created-teams-link">My Created Teams</a>
                            <a href="liked_teams.html" id="liked-teams-link">My Liked Teams</a>
                            <a href="#" id="logout-nav-link-dropdown">Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="search-bar-container">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="Search teams by title or creator...">
                    <button id="search-button">Search</button>
                </div>
                <button id="toggle-advanced-search-button" class="action-button small">Advanced</button>
            </div>
        </div>
    </header>

    <main class="container">
        <section id="advanced-search-section">
            <h2 id="advanced-search-title">Advanced Team Search</h2>
            <form id="advanced-search-form">
                <div class="form-group"><label for="adv-search-pokemon">Contains Pokémon:</label><input type="text" id="adv-search-pokemon" name="pokemon" list="pokemon-list-adv-search" placeholder="Pokémon name"></div>
                <div class="form-group"><label for="adv-search-item">Contains Item:</label><input type="text" id="adv-search-item" name="item" list="item-list-adv-search" placeholder="Item name"></div>
                <div class="form-group"><label for="adv-search-move">Contains Move:</label><input type="text" id="adv-search-move" name="move" list="move-list-adv-search" placeholder="Move name"></div>
                <div class="form-group"><label for="adv-search-format">Specific Format:</label><select id="adv-search-format" name="format"><option value="">Any Format</option></select></div>
                <div class="form-group">
                    <label for="adv-search-tags">Contains Tags (select one or more):</label>
                    <div id="adv-search-tags-container" class="tags-container">
                        {/* Tags checkboxes will be populated by JS */}
                    </div>
                </div>
                <button type="submit" class="action-button" style="width:100%; background-color: var(--primary);">Search Teams</button>
            </form>
            <div id="advanced-search-feedback" class="feedback-message" style="display:none;"></div>
        </section>

        <section id="login-section" class="auth-section">
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" name="email" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" name="password" required></div>
                <button type="submit" class="auth-button">Enter</button>
            </form>
            <div id="login-feedback" class="feedback-message" style="display:none;"></div>
            <a href="#" id="show-register-link" class="auth-toggle-link">Don't have an account? Register</a>
        </section>

        <section id="register-section" class="auth-section">
            <h2>Create Account</h2>
            <form id="register-form">
                <div class="form-group"><label for="register-username">Username</label><input type="text" id="register-username" name="username" required></div>
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" name="email" required></div>
                <div class="form-group"><label for="register-password">Password (min. 6 characters)</label><input type="password" id="register-password" name="password" required minlength="6"></div>
                <button type="submit" class="auth-button">Register</button>
            </form>
            <div id="register-feedback" class="feedback-message" style="display:none;"></div>
            <a href="#" id="show-login-link" class="auth-toggle-link">Already have an account? Login</a>
        </section>

        <section id="create-team-section">
            <h2 id="create-edit-team-title">Create New Pokémon Team</h2>
            <form id="create-team-form">
                <input type="hidden" id="editing-team-id" name="editingTeamId">
                <div class="form-group">
                    <label for="team-title-input">Team Title</label>
                    <input type="text" id="team-title-input" name="teamTitle" required>
                </div>
                <div class="form-group">
                    <label for="team-format-input">Competition Format</label>
                    <select id="team-format-input" name="teamFormat" required><option value="">Select a format...</option></select>
                </div>
                <div class="form-group">
                    <label>Team Tags (select all that apply):</label>
                    <div id="team-tags-checkbox-container" class="tags-container">
                        {/* Checkboxes for tags will be populated by JS */}
                    </div>
                </div>
                 <div class="form-group">
                    <label for="pokepaste-import-text">Import from Pokepaste (Paste Text)</label>
                    <textarea id="pokepaste-import-text" name="pokepasteImportText" rows="8" placeholder="Paste your full Pokepaste text here..."></textarea>
                    <button type="button" id="import-pokepaste-button" class="action-button">Import Pokepaste Data</button>
                </div>
                <div class="form-group">
                    <label for="team-description-input">Team Description / Guide</label>
                    <textarea id="team-description-input" name="teamDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="team-youtube-input">YouTube Link (Optional)</label>
                    <input type="url" id="team-youtube-input" name="teamYoutubeLink" placeholder="https://www.youtube.com/watch?v=...">
                </div>
                <h3 style="color: var(--secondary); margin-top: 2rem; margin-bottom: 1rem;">Team Pokémon (up to 6)</h3>
                <p style="font-size:0.85em; margin-bottom:1rem; color: #555;">Use the dropdown lists. "Desired Move/Ability" fields are for your reference and will be saved.</p>
                <div id="pokemon-forms-container"></div>
                <button type="submit" class="submit-team-button">Save Team</button>
            </form>
            <div id="create-team-feedback" class="feedback-message" style="display:none;"></div>
        </section>

        <section id="search-results-section" style="display: none;">
            <h2 id="search-results-title" class="section-title">Search Results</h2>
            <div class="team-grid" id="team-grid-search-results"></div>
        </section>

        <div id="main-content">
            <section class="featured-section">
                <h2 class="section-title">Featured Teams</h2>
                <div class="team-grid" id="team-grid-destacados"></div>
            </section>
            <section class="cta-section">
                <h2 class="cta-title">Create & Share Your Own Team</h2>
                <p class="cta-description">Got a winning combination? Share it with the community, get feedback, and help other trainers improve.</p>
                <a href="#" id="create-team-cta-button" class="cta-button">Create Team</a>
            </section>
            <section class="categories-section">
                <h2 class="section-title">Explore by Format</h2>
                <div class="category-list">
                    <div class="category-item active">All</div><div class="category-item">VGC 2025</div><div class="category-item">OU Singles</div>
                    <div class="category-item">UU Singles</div> <div class="category-item">Doubles</div> <div class="category-item">Monotype</div>
                </div>
            </section>
            <section class="featured-section">
                <h2 class="section-title">Popular Teams</h2>
                <div class="team-grid" id="team-grid-populares"><p style="grid-column: 1 / -1; text-align: center;">More popular teams coming soon...</p></div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column"><h3>Poké<span>Teams</span></h3><p>The ultimate community for sharing and discovering competitive Pokémon teams.</p></div>
                <div class="footer-column"><h3>Links</h3><ul class="footer-links"><li><a href="index.html">Home</a></li><li><a href="#" id="footer-create-team-link">Create Team</a></li><li><a href="calculadora.html">Damage Calculator</a></li></ul></div>
                <div class="footer-column"><h3>Resources</h3><ul class="footer-links"><li><a href="#">Pokémon Database</a></li></ul></div>
                <div class="footer-column"><h3>Information</h3><ul class="footer-links"><li><a href="acerca_de.html">About Us</a></li><li><a href="privacidad.html">Privacy Policy</a></li></ul></div>
            </div>
            <div class="footer-bottom"><p>© 2025 PokéTeams. Pokémon and Pokémon character names are trademarks of Nintendo.</p></div>
        </div>
    </footer>

    <datalist id="pokemon-list"></datalist> <datalist id="pokemon-list-adv-search"></datalist>
    <datalist id="item-list"></datalist> <datalist id="item-list-adv-search"></datalist>
    <datalist id="ability-list"></datalist>
    <datalist id="move-list"></datalist> <datalist id="move-list-adv-search"></datalist>
    <datalist id="nature-list">
        <option value="Adamant"></option><option value="Bashful"></option><option value="Bold"></option><option value="Brave"></option><option value="Calm"></option><option value="Careful"></option><option value="Docile"></option><option value="Gentle"></option><option value="Hardy"></option><option value="Hasty"></option><option value="Impish"></option><option value="Jolly"></option><option value="Lax"></option><option value="Lonely"></option><option value="Mild"></option><option value="Modest"></option><option value="Naive"></option><option value="Naughty"></option><option value="Quiet"></option><option value="Quirky"></option><option value="Rash"></option><option value="Relaxed"></option><option value="Sassy"></option><option value="Serious"></option><option value="Timid"></option>
    </datalist>
    <datalist id="type-list">
        <option value="Normal"></option><option value="Fire"></option><option value="Water"></option><option value="Electric"></option><option value="Grass"></option><option value="Ice"></option><option value="Fighting"></option><option value="Poison"></option><option value="Ground"></option><option value="Flying"></option><option value="Psychic"></option><option value="Bug"></option><option value="Rock"></option><option value="Ghost"></option><option value="Dragon"></option><option value="Dark"></option><option value="Steel"></option><option value="Fairy"></option>
    </datalist>

    <script>
        // ----- INICIO DEL SCRIPT -----
        document.addEventListener('DOMContentLoaded', () => {
            const WORKER_BASE_URL = 'https://poke-teams-auth.srcookriss.workers.dev';
            const REGISTER_URL = `${WORKER_BASE_URL}/api/register`;
            const LOGIN_URL = `${WORKER_BASE_URL}/api/login`;
            const TEAMS_URL = `${WORKER_BASE_URL}/api/teams`; 

            // --- Selectores de Elementos del DOM ---
            const loginSection = document.getElementById('login-section');
            const registerSection = document.getElementById('register-section');
            const createTeamSection = document.getElementById('create-team-section');
            const advancedSearchSection = document.getElementById('advanced-search-section');
            const searchResultsSection = document.getElementById('search-results-section');
            const mainContent = document.getElementById('main-content');

            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const createTeamForm = document.getElementById('create-team-form');
            const advancedSearchForm = document.getElementById('advanced-search-form');
            const pokemonFormsContainer = document.getElementById('pokemon-forms-container');
            
            const loginFeedback = document.getElementById('login-feedback');
            const registerFeedback = document.getElementById('register-feedback');
            const createTeamFeedback = document.getElementById('create-team-feedback');
            const advancedSearchFeedback = document.getElementById('advanced-search-feedback');

            const navLogoLink = document.getElementById('nav-logo-link');
            const homeLink = document.getElementById('home-link');
            const loginNav = document.getElementById('login-nav-link');
            const registerNav = document.getElementById('register-nav-link');
            const createTeamNavLink = document.getElementById('create-team-nav-link');
            const userMenuContainer = document.getElementById('user-menu-container');
            const userGreeting = document.getElementById('user-greeting');
            const userDropdownMenu = document.getElementById('user-dropdown-menu');
            const likedTeamsLink = document.getElementById('liked-teams-link');
            const myCreatedTeamsLink = document.getElementById('my-created-teams-link'); 
            const logoutNavDropdown = document.getElementById('logout-nav-link-dropdown'); 
            
            const showRegisterLink = document.getElementById('show-register-link'); 
            const showLoginLink = document.getElementById('show-login-link'); 
            const createTeamCtaButton = document.getElementById('create-team-cta-button');
            const footerCreateTeamLink = document.getElementById('footer-create-team-link');
            const importPokepasteButton = document.getElementById('import-pokepaste-button');
            const toggleAdvancedSearchButton = document.getElementById('toggle-advanced-search-button');
            const mainSearchButton = document.getElementById('search-button');
            const mainSearchInput = document.getElementById('search-input');

            const pokemonDatalist = document.getElementById('pokemon-list');
            const pokemonDatalistAdv = document.getElementById('pokemon-list-adv-search');
            const itemDatalist = document.getElementById('item-list');
            const itemDatalistAdv = document.getElementById('item-list-adv-search');
            const abilityDatalist = document.getElementById('ability-list');
            const moveDatalist = document.getElementById('move-list');
            const moveDatalistAdv = document.getElementById('move-list-adv-search');
            const advSearchFormatSelect = document.getElementById('adv-search-format');
            const teamFormatSelect = document.getElementById('team-format-input');
            const teamTagsContainer = document.getElementById('team-tags-checkbox-container');
            const advSearchTagsContainer = document.getElementById('adv-search-tags-container');


            let allTeamsData = {}; 

            // --- Carga de Datalists y Tags ---
            async function populateDatalist(url, datalistElement, nameKey = 'name', processFn = (name) => name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())) {
                if (!datalistElement) { console.warn("Datalist element not found for", url); return; }
                try {
                    let allResults = []; let nextUrl = url; let count = 0;
                    while (nextUrl && count < 20) { 
                        const response = await fetch(nextUrl);
                        if (!response.ok) { console.warn(`API error for ${url} (page ${count+1}): ${response.status}`); break; }
                        const data = await response.json();
                        allResults = allResults.concat(data.results);
                        nextUrl = data.next; count++;
                    }
                    allResults.sort((a, b) => a[nameKey].localeCompare(b[nameKey]));
                    datalistElement.innerHTML = ''; 
                    allResults.forEach(item => {
                        const option = document.createElement('option'); option.value = processFn(item[nameKey]);
                        datalistElement.appendChild(option);
                    });
                } catch (error) { console.error(`Error populating datalist from ${url}:`, error); }
            }
            const pokemonNameProcessor = name => name.charAt(0).toUpperCase() + name.slice(1).replace(/-/g, ' ');
            populateDatalist('https://pokeapi.co/api/v2/pokemon?limit=10000', pokemonDatalist, 'name', pokemonNameProcessor);
            populateDatalist('https://pokeapi.co/api/v2/pokemon?limit=10000', pokemonDatalistAdv, 'name', pokemonNameProcessor);
            populateDatalist('https://pokeapi.co/api/v2/item?limit=2000', itemDatalist);
            populateDatalist('https://pokeapi.co/api/v2/item?limit=2000', itemDatalistAdv);
            populateDatalist('https://pokeapi.co/api/v2/ability?limit=500', abilityDatalist);
            populateDatalist('https://pokeapi.co/api/v2/move?limit=1000', moveDatalist);
            populateDatalist('https://pokeapi.co/api/v2/move?limit=1000', moveDatalistAdv);

            const formats = ["VGC 2025 Series 1", "VGC 2024 Regulation G", "OU (OverUsed) Singles", "UU (UnderUsed) Singles", "RU (RarelyUsed) Singles", "NU (NeverUsed) Singles", "PU (PartiallyUsed) Singles", "LC (Little Cup)", "Doubles OU", "Monotype", "Battle Stadium Singles (BSS)", "Battle Stadium Doubles (BSD)", "Anything Goes (AG)", "Custom Game", "Other"];
            [advSearchFormatSelect, teamFormatSelect].forEach(selectElement => {
                if (selectElement) {
                    const firstOptionText = selectElement.options[0]?.textContent || "Select a format...";
                    selectElement.innerHTML = `<option value="">${firstOptionText}</option>`; 
                    formats.forEach(format => {
                        const option = document.createElement('option'); option.value = format; option.textContent = format;
                        selectElement.appendChild(option);
                    });
                }
            });
            
            const commonTags = ["Hyper Offense", "Balance", "Stall", "Trick Room", "Sun Team", "Rain Team", "Sand Team", "Snow Team", "VoltTurn", "Screens", "Entry Hazards", "Hazard Control", "Bulky Offense", "Choice User Spam"];
            function populateTagsCheckboxes(container, namePrefix) {
                if (!container) return;
                container.innerHTML = '';
                commonTags.forEach((tag, index) => {
                    const checkboxId = `${namePrefix}-tag-${tag.replace(/\s+/g, '-')}`; // ID más específico
                    const wrapper = document.createElement('div');
                    wrapper.className = 'tag-checkbox';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = checkboxId;
                    checkbox.name = `${namePrefix}Tags`; 
                    checkbox.value = tag;
                    const label = document.createElement('label');
                    label.htmlFor = checkboxId;
                    label.appendChild(document.createTextNode(` ${tag}`));
                    
                    wrapper.appendChild(checkbox);
                    wrapper.appendChild(label);
                    container.appendChild(wrapper);
                });
            }
            if (teamTagsContainer) populateTagsCheckboxes(teamTagsContainer, 'createTeam');
            if (advSearchTagsContainer) populateTagsCheckboxes(advSearchTagsContainer, 'advSearch');


            // --- Funciones de UI ---
            function showFeedback(element, message, isError = false) {
                if (!element) { console.warn("Feedback element not found for message:", message); return; }
                element.textContent = message;
                element.className = 'feedback-message ' + (isError ? 'error' : 'success');
                element.style.display = 'block';
                setTimeout(() => { if(element) element.style.display = 'none'; }, 5000);
            }
            function hideAllPageSections() {
                [loginSection, registerSection, createTeamSection, advancedSearchSection, searchResultsSection, mainContent].forEach(section => {
                    if (section) section.style.display = 'none';
                });
            }
            function showLoginForm() { hideAllPageSections(); if (loginSection) loginSection.style.display = 'block'; }
            function showRegisterForm() { hideAllPageSections(); if (registerSection) registerSection.style.display = 'block'; }
            function showCreateTeamForm(teamToEdit = null) {
                const user = localStorage.getItem('userData');
                if (user || teamToEdit) { 
                    hideAllPageSections();
                    if (createTeamSection) createTeamSection.style.display = 'block';
                    if (createTeamForm) createTeamForm.reset(); 
                    document.querySelectorAll('.ev-total').forEach(el => { el.textContent = 'Total EVs: 0 / 508'; el.style.color = 'var(--dark)';});
                    const editingTeamIdInput = document.getElementById('editing-team-id');
                    if (editingTeamIdInput) editingTeamIdInput.value = ''; 
                    const createEditTitle = document.getElementById('create-edit-team-title');
                    const submitButton = createTeamForm.querySelector('.submit-team-button');

                    if (pokemonFormsContainer && (pokemonFormsContainer.children.length === 0 || !teamToEdit || teamToEdit.id !== editingTeamIdInput.value )) { // Regenerar si es nuevo o diferente equipo
                        pokemonFormsContainer.innerHTML = ''; 
                        for (let i = 0; i < 6; i++) { pokemonFormsContainer.innerHTML += generatePokemonFormFields(i); }
                        document.querySelectorAll('.ev-input').forEach(input => input.addEventListener('input', handleEvInputChange));
                    }
                    if(teamTagsContainer) teamTagsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);


                    if (teamToEdit) { 
                        if(editingTeamIdInput) editingTeamIdInput.value = teamToEdit.id;
                        if(document.getElementById('team-title-input')) document.getElementById('team-title-input').value = teamToEdit.title || '';
                        if(document.getElementById('team-format-input')) document.getElementById('team-format-input').value = teamToEdit.format || '';
                        
                        if (teamTagsContainer && teamToEdit.tags && Array.isArray(teamToEdit.tags)) {
                            teamToEdit.tags.forEach(tagValue => {
                                const checkbox = teamTagsContainer.querySelector(`input[value="${tagValue}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        // Si los tags se guardaban como string separado por comas en versiones anteriores:
                        // else if (document.getElementById('team-tags-input') && typeof teamToEdit.tags === 'string') { 
                        //      document.getElementById('team-tags-input').value = teamToEdit.tags;
                        // }


                        if(document.getElementById('team-description-input')) document.getElementById('team-description-input').value = teamToEdit.description || '';
                        if(document.getElementById('team-youtube-input')) document.getElementById('team-youtube-input').value = teamToEdit.youtube_link || '';
                        
                        (teamToEdit.pokemons || []).forEach((pokemon, index) => {
                            if (index < 6) {
                                if(document.getElementById(`pokemon-name-${index}`)) document.getElementById(`pokemon-name-${index}`).value = pokemon.name || '';
                                if(document.getElementById(`pokemon-item-${index}`)) document.getElementById(`pokemon-item-${index}`).value = pokemon.item || '';
                                if(document.getElementById(`pokemon-ability-${index}`)) document.getElementById(`pokemon-ability-${index}`).value = pokemon.ability || '';
                                if(document.getElementById(`pokemon-desired-move-${index}`)) document.getElementById(`pokemon-desired-move-${index}`).value = pokemon.desired_move || '';
                                if(document.getElementById(`pokemon-desired-ability-${index}`)) document.getElementById(`pokemon-desired-ability-${index}`).value = pokemon.desired_ability || '';
                                if(document.getElementById(`pokemon-nature-${index}`)) document.getElementById(`pokemon-nature-${index}`).value = pokemon.nature || '';
                                if(document.getElementById(`pokemon-teratype-${index}`)) document.getElementById(`pokemon-teratype-${index}`).value = pokemon.tera_type || '';

                                const evs = parseEVsFromPokepasteString(pokemon.evs); 
                                ['hp', 'atk', 'def', 'spa', 'spd', 'spe'].forEach(stat => {
                                    const evInput = document.getElementById(`pokemon-${index}-ev-${stat.toLowerCase()}`);
                                    if (evInput) evInput.value = evs[stat.toUpperCase()] || 0;
                                });
                                const firstEvInput = document.getElementById(`pokemon-${index}-ev-hp`);
                                if (firstEvInput) handleEvInputChange({ target: firstEvInput }); 

                                (pokemon.moves || []).forEach((move, moveIdx) => {
                                    if (moveIdx < 4) {
                                        const moveInput = document.getElementById(`pokemon-${index}-move-${moveIdx}`);
                                        if (moveInput) moveInput.value = move;
                                    }
                                });
                            }
                        });
                        if(createEditTitle) createEditTitle.textContent = "Edit Pokémon Team";
                        if(submitButton) submitButton.textContent = "Update Team";
                    } else {
                        if(createEditTitle) createEditTitle.textContent = "Create New Pokémon Team";
                        if(submitButton) submitButton.textContent = "Save Team";
                        const pokepasteImportText = document.getElementById('pokepaste-import-text');
                        if (pokepasteImportText) pokepasteImportText.value = '';
                    }
                } else { alert("You must be logged in to create or edit a team."); showLoginForm(); }
            }
            function showAdvancedSearchForm() { hideAllPageSections(); if (advancedSearchSection) advancedSearchSection.style.display = 'block'; }
            function showMainContentPage() { 
                hideAllPageSections(); 
                if (mainContent) mainContent.style.display = 'block'; 
                renderAllTeamCards(null, 'team-grid-destacados');
            }
            function showSearchResults(teams, queryDescription) {
                hideAllPageSections();
                if (searchResultsSection) {
                    searchResultsSection.style.display = 'block';
                    const titleEl = document.getElementById('search-results-title');
                    if (titleEl) titleEl.textContent = queryDescription ? `Results for: ${queryDescription}` : "Search Results";
                    renderAllTeamCards(teams, 'team-grid-search-results');
                }
            }
            function updateNavForLoggedInUser(username) {
                if (loginNav) loginNav.style.display = 'none';
                if (registerNav) registerNav.style.display = 'none';
                if (createTeamNavLink) createTeamNavLink.style.display = 'list-item';
                if (userMenuContainer) userMenuContainer.style.display = 'list-item'; 
                if (userGreeting) userGreeting.textContent = `Hi, ${username}`;
                showMainContentPage();
            }
            function updateNavForLoggedOutUser() {
                if (loginNav) loginNav.style.display = 'list-item';
                if (registerNav) registerNav.style.display = 'list-item';
                if (createTeamNavLink) createTeamNavLink.style.display = 'none';
                if (userMenuContainer) userMenuContainer.style.display = 'none'; 
                if (userGreeting) userGreeting.textContent = '';
                showMainContentPage();
            }
            
            // --- Lógica de Autenticación ---
            async function handleAuthSubmit(event, url, formElement, feedbackElement, isRegister = false) {
                event.preventDefault();
                const formData = new FormData(formElement);
                const data = Object.fromEntries(formData.entries());
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    let result;
                    try { result = await response.json(); } 
                    catch (e) { 
                        const textResponse = await response.text();
                        showFeedback(feedbackElement, `Error: Unexpected server response. (${response.status}) - ${textResponse}`, true); return; 
                    }

                    if (response.ok) {
                        if (isRegister) {
                            showFeedback(feedbackElement, `Registration successful! ${result.message || ''}. You can now log in.`, false);
                            formElement.reset(); setTimeout(showLoginForm, 2000);
                        } else { 
                            showFeedback(feedbackElement, `Login successful! Welcome, ${result.user?.username || 'user'}.`, false);
                            formElement.reset(); localStorage.setItem('userData', JSON.stringify(result.user)); 
                            updateNavForLoggedInUser(result.user?.username);
                        }
                    } else { showFeedback(feedbackElement, `Error: ${result.error || response.statusText || 'Unknown server error.'}`, true); }
                } catch (error) { 
                    showFeedback(feedbackElement, `Connection error: ${error.message}. Please check the console.`, true); 
                }
            }
            if (registerForm) registerForm.addEventListener('submit', (e) => handleAuthSubmit(e, REGISTER_URL, registerForm, registerFeedback, true));
            if (loginForm) loginForm.addEventListener('submit', (e) => handleAuthSubmit(e, LOGIN_URL, loginForm, loginFeedback));
            
            // --- User Menu Dropdown ---
            if (userGreeting && userDropdownMenu) {
                userGreeting.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdownMenu.style.display = userDropdownMenu.style.display === 'block' ? 'none' : 'block';
                });
                document.addEventListener('click', (e) => { 
                    if (userMenuContainer && !userMenuContainer.contains(e.target) && userDropdownMenu.style.display === 'block') {
                        userDropdownMenu.style.display = 'none';
                    }
                });
            }
            if (logoutNavDropdown) logoutNavDropdown.addEventListener('click', (e) => { 
                e.preventDefault(); 
                localStorage.removeItem('userData'); 
                if(userDropdownMenu) userDropdownMenu.style.display = 'none';
                updateNavForLoggedOutUser(); 
            });
            if (likedTeamsLink) likedTeamsLink.addEventListener('click', (e) => {
                e.preventDefault();
                const user = JSON.parse(localStorage.getItem('userData'));
                if (user && user.id) {
                    window.open(`liked_teams.html?userId=${user.id}`, '_self'); 
                } else {
                    alert("You must be logged in to see your liked teams.");
                    showLoginForm();
                }
            });
            if (myCreatedTeamsLink) myCreatedTeamsLink.addEventListener('click', (e) => {
                e.preventDefault();
                 const user = JSON.parse(localStorage.getItem('userData'));
                if (user && user.id) {
                    window.open(`my_teams.html?userId=${user.id}`, '_self');
                } else {
                    alert("You must be logged in to see your created teams.");
                    showLoginForm();
                }
            });


            // --- Manejo de Navegación ---
            if (navLogoLink) navLogoLink.addEventListener('click', (e) => { e.preventDefault(); showMainContentPage(); });
            if (loginNav) loginNav.addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            if (registerNav) registerNav.addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            if (createTeamNavLink) createTeamNavLink.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });
            if (showLoginLink) showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            if (showRegisterLink) showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            if (homeLink) homeLink.addEventListener('click', (e) => { e.preventDefault(); showMainContentPage(); });
            if (createTeamCtaButton) createTeamCtaButton.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });
            if (footerCreateTeamLink) footerCreateTeamLink.addEventListener('click', (e) => { e.preventDefault(); showCreateTeamForm(); });
            if (toggleAdvancedSearchButton) toggleAdvancedSearchButton.addEventListener('click', (e) => {
                e.preventDefault();
                const isAdvancedSearchVisible = advancedSearchSection && advancedSearchSection.style.display === 'block';
                if (isAdvancedSearchVisible) { showMainContentPage(); } 
                else { showAdvancedSearchForm(); }
            });
            
            // --- Carga y Renderizado de Equipos ---
            async function fetchFromPokeAPI(endpoint) { /* ... */ return null; } 

            async function fetchTeamsFromBackend(queryParams = {}) {
                const url = new URL(TEAMS_URL);
                Object.keys(queryParams).forEach(key => {
                    if (queryParams[key]) {
                        if (key === 'tags' && Array.isArray(queryParams[key])) { // Si tags es un array
                            queryParams[key].forEach(tag => url.searchParams.append('tag', tag));
                        } else {
                            url.searchParams.append(key, queryParams[key]);
                        }
                    }
                });
                try {
                    const response = await fetch(url.toString());
                    if (!response.ok) {
                        console.error("Error fetching teams:", response.status, response.statusText);
                        return { teams: [], total: 0 };
                    }
                    const data = await response.json();
                    return { teams: data.teams || [], total: data.total || 0 };
                } catch (error) {
                    console.error("Error fetching teams from backend:", error);
                    return { teams: [], total: 0 };
                }
            }
            
            function renderTeamCard(team) {
                const currentUser = JSON.parse(localStorage.getItem('userData'));
                // No mostrar botones de editar/eliminar en index.html
                // const isOwner = currentUser && team.user_id === currentUser.id; 
                let pokemonIconsHtml = '';
                (team.pokemons || []).slice(0, 6).forEach(p => {
                    const pokemonNameForSprite = p.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/gi, '');
                    const pokemonSpriteUrl = `https://play.pokemonshowdown.com/sprites/gen5/${pokemonNameForSprite}.png`;
                    pokemonIconsHtml += `<div class="pokemon-icon-preview"><img src="${pokemonSpriteUrl}" alt="${p.name}" onerror="this.src='https://placehold.co/60x60/cccccc/969696?text=${p.name.substring(0,1).toUpperCase()}&font=roboto'; this.alt='${p.name}'"><div class="pokemon-name-preview">${p.name.charAt(0).toUpperCase() + p.name.slice(1)}</div></div>`;
                });
                return `
                    <div class="team-card" data-team-id="${team.id}">
                        <div class="team-header"><div class="team-title">${team.title}</div><div class="team-format">${team.format}</div></div>
                        <div class="team-pokemon-preview">${pokemonIconsHtml}</div>
                        <div class="team-footer">
                            <div class="team-footer-top-row">
                                <div class="team-stats">
                                    <div class="stat like-stat can-like" data-team-id="${team.id}">👍 ${team.likes || 0}</div> 
                                    <div class="stat">💬 ${team.comments_count || 0}</div> 
                                </div>
                                <div class="team-creator">By: ${team.creator || 'Unknown'}</div>
                            </div>
                            <div class="team-actions">
                                <button class="team-action-button pokepaste-button">Copy Pokepaste</button>
                                <button class="team-action-button view-details-button">View Details</button>
                                <button class="team-action-button like-team-button" data-team-id="${team.id}">Like</button>
                                {/* Edit/Delete buttons removed from here, will be on my_teams.html */}
                            </div>
                        </div></div>`;
            }
            
            const teamGridDestacados = document.getElementById('team-grid-destacados');
            const teamGridSearchResults = document.getElementById('team-grid-search-results');

            async function renderAllTeamCards(teamsArray = null, targetGridId = 'team-grid-destacados') {
                const teamsToRenderArray = teamsArray || Object.values(allTeamsData);
                const targetGridElement = document.getElementById(targetGridId);

                if (targetGridElement) {
                    if (teamsToRenderArray.length === 0) {
                        if (targetGridId === 'team-grid-search-results') {
                            targetGridElement.innerHTML = "<p style='grid-column: 1 / -1; text-align: center;'>No teams found matching your criteria.</p>";
                        } else { 
                            targetGridElement.innerHTML = "<p style='grid-column: 1 / -1; text-align: center;'>No teams to display. Create one or wait for teams to load!</p>";
                        }
                    } else {
                        targetGridElement.innerHTML = teamsToRenderArray.map(renderTeamCard).join('');
                    }
                    
                    targetGridElement.querySelectorAll('.view-details-button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const teamCard = event.target.closest('.team-card');
                            if (teamCard) {
                                const teamId = teamCard.dataset.teamId;
                                if (allTeamsData[teamId]) { 
                                    localStorage.setItem('currentTeamDetails', JSON.stringify(allTeamsData[teamId]));
                                    window.open(`team_detail.html?teamId=${teamId}`, '_blank');
                                } else { alert("Error: Could not load team details."); }
                            }
                        });
                    });
                    targetGridElement.querySelectorAll('.pokepaste-button').forEach(button => {
                         button.addEventListener('click', (event) => {
                            const teamCard = event.target.closest('.team-card');
                            if (teamCard) {
                                const team = allTeamsData[teamCard.dataset.teamId];
                                if (team) {
                                    const pokepasteText = generatePokepasteStringFromTeamData(team);
                                    navigator.clipboard.writeText(pokepasteText).then(() => {
                                        alert('Team copied to Pokepaste format!\n\n' + pokepasteText);
                                    }).catch(err => { alert('Error copying. Check console.'); });
                                }
                            }
                        });
                    });
                    targetGridElement.querySelectorAll('.like-team-button').forEach(button => button.addEventListener('click', handleLikeTeamClick));
                    // No hay botones de editar/eliminar aquí directamente
                }
            }
            
            async function initializePage() {
                const storedUserData = localStorage.getItem('userData');
                if (storedUserData) {
                    try { const userData = JSON.parse(storedUserData); updateNavForLoggedInUser(userData.username); }
                    catch (e) { localStorage.removeItem('userData'); updateNavForLoggedOutUser(); }
                } else {
                    updateNavForLoggedOutUser();
                }
                const fetchedData = await fetchTeamsFromBackend(); 
                allTeamsData = fetchedData.teams.reduce((obj, team) => { obj[team.id] = team; return obj; }, {});
                localStorage.setItem('allTeamsData', JSON.stringify(allTeamsData)); 
                renderAllTeamCards(null, 'team-grid-destacados'); 

                if (window.location.hash === '#edit-team') {
                    const teamToEditString = localStorage.getItem('teamToEdit');
                    if (teamToEditString) {
                        const teamToEdit = JSON.parse(teamToEditString);
                        showCreateTeamForm(teamToEdit);
                        localStorage.removeItem('teamToEdit'); 
                    }
                    window.location.hash = ''; 
                } else if (window.location.hash === '#create-team') {
                    showCreateTeamForm();
                     window.location.hash = '';
                } else if (window.location.hash === '#login') {
                    showLoginForm();
                     window.location.hash = '';
                } else if (window.location.hash === '#register') {
                    showRegisterForm();
                     window.location.hash = '';
                }
            }
            initializePage();


            function generatePokepasteStringFromTeamData(teamDetails) {
                if (!teamDetails || !teamDetails.pokemons) return "";
                let pasteString = "";
                teamDetails.pokemons.forEach(p => {
                    pasteString += `${p.name.charAt(0).toUpperCase() + p.name.slice(1)} @ ${p.item ? p.item.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'None'}\n`;
                    pasteString += `Ability: ${p.ability ? p.ability.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'}\n`;
                    if (p.level) pasteString += `Level: ${p.level}\n`;
                    if (p.tera_type) pasteString += `Tera Type: ${p.tera_type.charAt(0).toUpperCase() + p.tera_type.slice(1)}\n`;
                    pasteString += `EVs: ${p.evs}\n`;
                    pasteString += `${p.nature} Nature\n`;
                    (p.moves || []).forEach(move => { 
                        pasteString += `- ${move.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}\n`;
                    });
                    pasteString += `\n`;
                });
                return pasteString.trim();
            }

            // --- Lógica para Crear y Editar Equipo ---
            function generatePokemonFormFields(index) {
                const evStats = ['HP', 'Atk', 'Def', 'SpA', 'SpD', 'Spe'];
                let evInputsHtml = `<label style="grid-column: 1 / -1; text-align:left; margin-bottom:0.3rem;">EVs:</label><div class="evs-grid">`;
                evStats.forEach(stat => {
                    evInputsHtml += `<div><label for="pokemon-${index}-ev-${stat.toLowerCase()}">${stat}</label><input type="number" id="pokemon-${index}-ev-${stat.toLowerCase()}" name="pokemon-${index}-ev-${stat.toLowerCase()}" min="0" max="252" value="0" class="ev-input" data-pokemon-idx="${index}"></div>`;
                });
                evInputsHtml += '</div>';
                return `
                    <div class="pokemon-form-block" data-pokemon-idx="${index}">
                        <h4>Pokémon ${index + 1}</h4>
                        <div class="form-group"><label for="pokemon-name-${index}">Name</label><input type="text" id="pokemon-name-${index}" name="pokemon-${index}-name" list="pokemon-list" placeholder="E.g., Pikachu"></div>
                        <div class="form-group"><label for="pokemon-item-${index}">Item</label><input type="text" id="pokemon-item-${index}" name="pokemon-${index}-item" list="item-list" placeholder="E.g., Light Ball"></div>
                        <div class="form-group"><label for="pokemon-ability-${index}">Ability</label><input type="text" id="pokemon-ability-${index}" name="pokemon-${index}-ability" list="ability-list" placeholder="E.g., Static"></div>
                        <div class="form-group"><label for="pokemon-desired-move-${index}">Desired Move (reference)</label><input type="text" id="pokemon-desired-move-${index}" name="pokemon-${index}-desired-move" list="move-list" placeholder="E.g., Thunderbolt"></div>
                        <div class="form-group"><label for="pokemon-desired-ability-${index}">Desired Ability (reference)</label><input type="text" id="pokemon-desired-ability-${index}" name="pokemon-${index}-desired-ability" list="ability-list" placeholder="E.g., Lightning Rod"></div>
                        ${evInputsHtml}
                        <div class="ev-total" id="ev-total-display-${index}">Total EVs: 0 / 508</div>
                        <div class="form-group"><label for="pokemon-nature-${index}">Nature</label><input type="text" id="pokemon-nature-${index}" name="pokemon-${index}-nature" list="nature-list" placeholder="E.g., Timid"></div>
                        <div class="form-group"><label for="pokemon-teratype-${index}">Tera Type</label><input type="text" id="pokemon-teratype-${index}" name="pokemon-${index}-teraType" list="type-list" placeholder="E.g., Water"></div>
                        <label>Moves (4):</label><div class="moves-grid">
                            ${[0,1,2,3].map(moveIdx => `<div class="form-group"><input type="text" id="pokemon-${index}-move-${moveIdx}" name="pokemon-${index}-move${moveIdx+1}" list="move-list" placeholder="Move ${moveIdx+1}"></div>`).join('')}
                        </div></div>`;
            }

            if (pokemonFormsContainer) { 
                pokemonFormsContainer.innerHTML = ''; 
                for (let i = 0; i < 6; i++) { pokemonFormsContainer.innerHTML += generatePokemonFormFields(i); }
                document.querySelectorAll('.ev-input').forEach(input => input.addEventListener('input', handleEvInputChange));
            }
            function handleEvInputChange(event) {
                const targetInput = event.target; const pokemonIdx = targetInput.dataset.pokemonIdx;
                const allEvInputsForPokemon = document.querySelectorAll(`.ev-input[data-pokemon-idx="${pokemonIdx}"]`);
                let currentTotalEvs = 0;
                allEvInputsForPokemon.forEach(input => {
                    let value = parseInt(input.value) || 0; if (value < 0) value = 0; if (value > 252) value = 252;
                    input.value = value; currentTotalEvs += value;
                });
                const totalDisplay = document.getElementById(`ev-total-display-${pokemonIdx}`);
                if (totalDisplay) {
                    totalDisplay.textContent = `Total EVs: ${currentTotalEvs} / 508`;
                    totalDisplay.style.color = currentTotalEvs > 508 ? 'var(--danger)' : 'var(--dark)';
                }
                if (currentTotalEvs > 508 && createTeamFeedback) showFeedback(createTeamFeedback, `Total EVs for Pokémon ${parseInt(pokemonIdx)+1} exceeds 508. (Current: ${currentTotalEvs})`, true);
                else if (createTeamFeedback && createTeamFeedback.classList.contains('error') && createTeamFeedback.textContent.includes(`Pokémon ${parseInt(pokemonIdx)+1}`)) { createTeamFeedback.style.display = 'none'; }
            }

            if (createTeamForm) {
                createTeamForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const formData = new FormData(createTeamForm); 
                    const loggedInUser = JSON.parse(localStorage.getItem('userData'));
                    if (!loggedInUser) { showFeedback(createTeamFeedback, 'You must be logged in to save a team.', true); showLoginForm(); return; }

                    const editingTeamId = formData.get('editingTeamId');
                    const selectedTags = [];
                    teamTagsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                        selectedTags.push(cb.value);
                    });

                    const teamPayload = {
                        userId: loggedInUser.id, 
                        title: formData.get('teamTitle'), 
                        format: formData.get('teamFormat'),
                        tags: selectedTags,
                        description: formData.get('teamDescription'), 
                        youtubeLink: formData.get('teamYoutubeLink'),
                        pokemons: []
                    };
                    let globalEvError = false;
                    for (let i = 0; i < 6; i++) {
                        const pokemonNameInput = formData.get(`pokemon-${i}-name`);
                        if (pokemonNameInput && pokemonNameInput.trim() !== "") {
                            let pokemonEvTotal = 0; const evs = {};
                            ['hp', 'atk', 'def', 'spa', 'spd', 'spe'].forEach(stat => {
                                const evValue = parseInt(formData.get(`pokemon-${i}-ev-${stat.toLowerCase()}`)) || 0;
                                evs[stat.toUpperCase()] = evValue; pokemonEvTotal += evValue;
                            });
                            if (pokemonEvTotal > 508) { globalEvError = true; break; }
                            
                            const pokeApiName = pokemonNameInput.toLowerCase().replace(/\s+/g, '-');
                            const pokeData = await fetchFromPokeAPI(`pokemon/${pokeApiName}`);
                            const pokemonTypes = pokeData && pokeData.types ? pokeData.types.map(typeInfo => typeInfo.type.name) : [];

                            teamPayload.pokemons.push({
                                name: pokemonNameInput, 
                                item: formData.get(`pokemon-${i}-item`), 
                                ability: formData.get(`pokemon-${i}-ability`),
                                desired_ability: formData.get(`pokemon-${i}-desired-ability`), 
                                desired_move: formData.get(`pokemon-${i}-desired-move`), 
                                evs: `${evs.HP} HP / ${evs.Atk} Atk / ${evs.Def} Def / ${evs.SpA} SpA / ${evs.SpD} SpD / ${evs.Spe} Spe`,
                                nature: formData.get(`pokemon-${i}-nature`), 
                                tera_type: formData.get(`pokemon-${i}-teraType`),
                                moves: [1,2,3,4].map(mIdx => formData.get(`pokemon-${i}-move${mIdx}`)).filter(move => move && move.trim() !== ''),
                                types: pokemonTypes
                            });
                        }
                    }
                    if (globalEvError) { showFeedback(createTeamFeedback, `One or more Pokémon exceed the total of 508 EVs.`, true); return; }
                    if (teamPayload.pokemons.length === 0) { showFeedback(createTeamFeedback, `You must add at least one Pokémon.`, true); return; }

                    const url = editingTeamId ? `${TEAMS_URL}/${editingTeamId}` : TEAMS_URL;
                    const method = editingTeamId ? 'PUT' : 'POST';

                    try {
                        const response = await fetch(url, {
                            method: method, 
                            headers: { 'Content-Type': 'application/json', 'X-User-Id': loggedInUser.id }, 
                            body: JSON.stringify(teamPayload)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            showFeedback(createTeamFeedback, `Team ${editingTeamId ? 'updated' : 'created'} successfully!`, false);
                            createTeamForm.reset();
                            document.querySelectorAll('.ev-total').forEach(el => { el.textContent = 'Total EVs: 0 / 508'; el.style.color = 'var(--dark)';});
                            const fetchedData = await fetchTeamsFromBackend(); 
                            allTeamsData = fetchedData.teams.reduce((obj, team) => { obj[team.id] = team; return obj; }, {});
                            localStorage.setItem('allTeamsData', JSON.stringify(allTeamsData));
                            renderAllTeamCards();
                            setTimeout(showMainContentPage, 2000);
                        } else { showFeedback(createTeamFeedback, `Error: ${result.error || response.statusText}`, true); }
                    } catch (error) { showFeedback(createTeamFeedback, 'Connection error while saving team.', true); }
                });
            }
            
            if (importPokepasteButton) {
                importPokepasteButton.addEventListener('click', () => {
                    const pokepasteTextInput = document.getElementById('pokepaste-import-text');
                    const pasteText = pokepasteTextInput.value.trim();
                    if (!pasteText) { showFeedback(createTeamFeedback, "Please paste the Pokepaste text.", true); return; }
                    const parsedPokemons = parsePokepaste(pasteText);
                    if (parsedPokemons.length > 0) {
                        fillCreateTeamForm(parsedPokemons, true); 
                        showFeedback(createTeamFeedback, "Data imported. Please review and complete EV distribution.", false);
                    } else { showFeedback(createTeamFeedback, "Could not parse data from Pokepaste.", true); }
                });
            }

            function parsePokepaste(text) {
                const pokemons = []; const sections = text.trim().split(/\n\s*\n/);
                sections.forEach(section => {
                    if (section.trim() === "") return;
                    const lines = section.trim().split('\n');
                    const pokemon = { name: '', item: '', ability: '', evs: '', nature: '', tera_type: '', moves: [] };
                    const firstLineMatch = lines[0].match(/^(.+?)(?:\s@\s(.+))?$/);
                    if (firstLineMatch) { 
                        pokemon.name = firstLineMatch[1].trim(); 
                        if (firstLineMatch[2]) pokemon.item = firstLineMatch[2].trim(); 
                    } else { pokemon.name = lines[0].trim(); }
                    
                    lines.slice(1).forEach(line => {
                        line = line.trim();
                        if (line.startsWith('Ability: ')) pokemon.ability = line.substring('Ability: '.length).trim();
                        else if (line.startsWith('EVs: ')) pokemon.evs = line.substring('EVs: '.length).trim();
                        else if (line.endsWith(' Nature')) pokemon.nature = line.replace(' Nature', '').trim();
                        else if (line.startsWith('Tera Type: ')) pokemon.tera_type = line.substring('Tera Type: '.length).trim();
                        else if (line.startsWith('- ')) pokemon.moves.push(line.substring(2).trim());
                    });
                    if (pokemon.name) pokemons.push(pokemon);
                });
                return pokemons.slice(0, 6);
            }
            function fillCreateTeamForm(parsedPokemons, isImport = true) {
                parsedPokemons.forEach((pokemon, index) => {
                    if (index >= 6) return;
                    if(document.getElementById(`pokemon-name-${index}`)) document.getElementById(`pokemon-name-${index}`).value = pokemon.name || '';
                    if(document.getElementById(`pokemon-item-${index}`)) document.getElementById(`pokemon-item-${index}`).value = pokemon.item || '';
                    if(document.getElementById(`pokemon-ability-${index}`)) document.getElementById(`pokemon-ability-${index}`).value = pokemon.ability || '';
                    if(document.getElementById(`pokemon-nature-${index}`)) document.getElementById(`pokemon-nature-${index}`).value = pokemon.nature || '';
                    if(document.getElementById(`pokemon-teratype-${index}`)) document.getElementById(`pokemon-teratype-${index}`).value = pokemon.tera_type || '';
                    
                    const evSpread = parseEVsFromPokepasteString(pokemon.evs);
                    ['hp', 'atk', 'def', 'spa', 'spd', 'spe'].forEach(stat => {
                        const evInput = document.getElementById(`pokemon-${index}-ev-${stat.toLowerCase()}`);
                        if (evInput) evInput.value = evSpread[stat.toUpperCase()] || 0;
                    });
                    const firstEvInput = document.getElementById(`pokemon-${index}-ev-hp`);
                    if (firstEvInput) handleEvInputChange({ target: firstEvInput }); 

                    (pokemon.moves || []).forEach((move, moveIdx) => {
                        if (moveIdx < 4) {
                            const moveInput = document.getElementById(`pokemon-${index}-move-${moveIdx}`);
                            if (moveInput) moveInput.value = move;
                        }
                    });
                    if (isImport) {
                        if(document.getElementById(`pokemon-desired-move-${index}`)) document.getElementById(`pokemon-desired-move-${index}`).value = '';
                        if(document.getElementById(`pokemon-desired-ability-${index}`)) document.getElementById(`pokemon-desired-ability-${index}`).value = '';
                    }
                });
            }
            function parseEVsFromPokepasteString(evString) {
                const evs = { HP: 0, Atk: 0, Def: 0, SpA: 0, SpD: 0, Spe: 0 };
                if (!evString) return evs;
                const parts = evString.split('/');
                parts.forEach(part => {
                    const match = part.trim().match(/(\d+)\s+(HP|Atk|Def|SpA|SpD|Spe)/i);
                    if (match && evs.hasOwnProperty(match[2].toUpperCase())) {
                        evs[match[2].toUpperCase()] = parseInt(match[1]);
                    }
                });
                return evs;
            }

            // --- Búsqueda ---
            async function performSearch(filters) {
                const queryParams = new URLSearchParams();
                let queryDescriptionParts = [];

                if (filters.title) { 
                    queryParams.append('title', filters.title); 
                    queryDescriptionParts.push(`Title/Creator: "${filters.title}"`);
                }
                if (filters.pokemon) { queryParams.append('pokemon', filters.pokemon); queryDescriptionParts.push(`Pokémon: ${filters.pokemon}`);}
                if (filters.item) { queryParams.append('item', filters.item); queryDescriptionParts.push(`Item: ${filters.item}`);}
                if (filters.move) { queryParams.append('move', filters.move); queryDescriptionParts.push(`Move: ${filters.move}`);}
                if (filters.format) { queryParams.append('format', filters.format); queryDescriptionParts.push(`Format: ${filters.format}`);}
                if (filters.tags) { 
                    // Si el backend espera 'tag' como parámetro único para un solo tag, o un array para múltiples.
                    // Asumiendo que el backend puede manejar un string de tags separados por coma o un array.
                    // Si el backend espera múltiples parámetros 'tag', se debe ajustar.
                    queryParams.append('tags', filters.tags); // O iterar y append 'tag' para cada uno
                    queryDescriptionParts.push(`Tags: ${filters.tags}`);
                }
                const queryDescription = queryDescriptionParts.length > 0 ? queryDescriptionParts.join(', ') : "All Teams";

                try {
                    const { teams: fetchedTeams, total } = await fetchTeamsFromBackend(Object.fromEntries(queryParams));
                    showSearchResults(fetchedTeams, queryDescription);
                } catch (error) {
                    console.error("Error in search:", error);
                    if(advancedSearchFeedback) showFeedback(advancedSearchFeedback, "Error performing search.", true);
                    else if (document.getElementById('search-results-title')) showFeedback(document.getElementById('search-results-title').parentElement.querySelector('.feedback-message'), "Error searching.", true);
                }
            }

            if(mainSearchButton && mainSearchInput) {
                mainSearchButton.addEventListener('click', () => {
                    const searchTerm = mainSearchInput.value.trim();
                    if (searchTerm) {
                        performSearch({ title: searchTerm.toLowerCase() });
                    } else { showMainContentPage(); }
                });
                mainSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') mainSearchButton.click(); });
            }

            if (advancedSearchForm) {
                advancedSearchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(advancedSearchForm);
                    const selectedTags = [];
                    advSearchTagsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                        selectedTags.push(cb.value);
                    });

                    const filters = {
                        pokemon: formData.get('pokemon')?.trim(),
                        item: formData.get('item')?.trim(),
                        move: formData.get('move')?.trim(),
                        format: formData.get('format'),
                        tags: selectedTags.join(',') // Enviar tags como string separado por comas
                    };
                    performSearch(filters);
                    if (advancedSearchFeedback) showFeedback(advancedSearchFeedback, `Advanced search applied.`, false);
                });
            }

            // --- Acciones de Equipo (Like, Editar, Eliminar) ---
            async function handleLikeTeamClick(event) {
                const teamId = event.target.dataset.teamId;
                const user = JSON.parse(localStorage.getItem('userData'));
                if (!user) { alert("You must be logged in to like a team."); return; }
                try {
                    const response = await fetch(`${TEAMS_URL}/${teamId}/like`, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-User-Id': user.id },
                        body: JSON.stringify({ userId: user.id }) 
                    });
                    const result = await response.json();
                    if (response.ok) {
                        if(allTeamsData[teamId]) {
                            allTeamsData[teamId].likes = result.likes;
                            const likeButton = event.target;
                            likeButton.classList.toggle('liked', result.liked); 
                            likeButton.closest('.team-card').querySelector('.like-stat').textContent = `👍 ${result.likes}`;
                        }
                        localStorage.setItem('allTeamsData', JSON.stringify(allTeamsData));
                    } else { alert(`Error liking team: ${result.error}`); }
                } catch (error) { alert("Connection error while liking team."); }
            }

            // handleEditTeamClick se llamará desde my_teams.html, no directamente desde las tarjetas de index.html
            // async function handleDeleteTeamClick(event) { ... } // Se llamará desde my_teams.html
        });
    </script>
</body>
</html>
