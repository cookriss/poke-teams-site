<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Daño Pokémon - PokéTeams</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #ff5350; --primary-dark: #d13330; --secondary: #3b4cca; --light: #f8f9fa;
            --dark: #343a40; --success: #30c58b; --danger: #dc3545;
            --type-normal: #A8A77A; --type-fire: #EE8130; --type-water: #6390F0; --type-electric: #F7D02C;
            --type-grass: #7AC74C; --type-ice: #96D9D6; --type-fighting: #C22E28; --type-poison: #A33EA1;
            --type-ground: #E2BF65; --type-flying: #A98FF3; --type-psychic: #F95587; --type-bug: #A6B91A;
            --type-rock: #B6A136; --type-ghost: #735797; --type-dragon: #6F35FC; --type-dark: #705746;
            --type-steel: #B7B7CE; --type-fairy: #D685AD;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #f4f4f4; color: var(--dark); line-height: 1.6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { width: 95%; max-width: 1400px; margin: 0 auto; }
        header { background-color: var(--primary); color: white; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .navbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; text-decoration: none; color: white;}
        .logo span { color: var(--secondary); }
        .nav-links { display: flex; list-style: none; flex-wrap: wrap; padding-left: 0;}
        .nav-links li { margin-left: 1rem; margin-bottom: 0.5rem; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s, background-color 0.3s; padding: 0.3rem 0.5rem; border-radius: 5px; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background-color: white; }
        
        main.container { padding-top: 1rem; }
        .page-title { color: var(--primary); text-align: center; margin-bottom: 1.5rem; font-size: 2rem; }

        .calculator-layout { display: flex; flex-wrap: wrap; gap: 1.5rem; }
        .team-setup-column { flex: 1; min-width: 300px; background-color: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);}
        .team-setup-column h3 { color: var(--secondary); margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        
        .pokemon-slot { margin-bottom: 1.5rem; border: 1px dashed #ccc; padding: 1rem; border-radius: 5px; }
        .pokemon-slot h4 { margin-bottom: 0.75rem; font-size: 1.1rem; }

        .form-group { margin-bottom: 0.75rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 500; font-size: 0.9rem; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select {
            width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;
        }
        .form-group input[type="checkbox"] { width: auto; margin-right: 0.5rem;}

        .evs-grid-calc { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .evs-grid-calc div { display: flex; flex-direction: column; }
        .evs-grid-calc label { font-size: 0.8rem; text-align: center; margin-bottom: 0.1rem;}
        .evs-grid-calc input { text-align: center; }
        .ev-total-calc { font-size: 0.85rem; text-align: right; margin-top: 0.3rem; font-weight: bold; }

        .attack-phase { flex-basis: 100%; margin-top: 1.5rem; background-color: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        .attack-phase h3 { color: var(--primary); }
        .attack-selectors { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; align-items: flex-end; }
        .attack-selectors .form-group { flex: 1; min-width: 150px; }
        
        .modifiers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem;}
        .modifier-group { display: flex; flex-direction: column; }
        .modifier-group label { font-weight: bold; margin-bottom: 0.3rem; font-size: 0.9rem; }
        .modifier-group .checkbox-label { font-weight: normal; display: flex; align-items: center; font-size: 0.85rem;}


        .calculate-button {
            background-color: var(--success); color: white; padding: 0.75rem 1.5rem; border: none;
            border-radius: 25px; font-weight: bold; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s; display: block; width: auto; margin-top: 1rem;
        }
        .calculate-button:hover { background-color: #25a270; }

        .results-section { margin-top: 1rem; padding: 1rem; background-color: #f9f9f9; border-radius: 5px; }
        .results-section h4 { margin-bottom: 0.5rem; }
        #calc-output { white-space: pre-wrap; font-family: monospace; background-color: #eee; padding: 0.75rem; border-radius: 4px; max-height: 300px; overflow-y: auto;}

        footer { /* ... (estilos del footer de index.html) ... */ }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="index.html" class="logo">Poké<span>Teams</span></a>
                <ul class="nav-links">
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="acerca_de.html">Acerca de</a></li>
                    <li><a href="privacidad.html">Privacidad</a></li>
                </ul>
            </div>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">Calculadora de Daño Pokémon</h1>

        <div class="calculator-layout">
            <div class="team-setup-column" id="team-a-setup">
                <h3>Equipo A (Atacante)</h3>
                <div class="pokemon-slot" id="team-a-poke-1">
                    <h4>Pokémon 1</h4>
                    <div class="form-group"><label for="team-a-p1-name">Nombre:</label><input type="text" id="team-a-p1-name" list="pokemon-list-calc" placeholder="Ej: Pikachu"></div>
                    <div class="form-group"><label for="team-a-p1-level">Nivel:</label><input type="number" id="team-a-p1-level" value="50" min="1" max="100"></div>
                    <div class="form-group"><label for="team-a-p1-item">Objeto:</label><input type="text" id="team-a-p1-item" list="item-list-calc" placeholder="Ej: Light Ball"></div>
                    <div class="form-group"><label for="team-a-p1-ability">Habilidad:</label><input type="text" id="team-a-p1-ability" list="ability-list-calc" placeholder="Ej: Static"></div>
                    <div class="form-group"><label for="team-a-p1-nature">Naturaleza:</label><input type="text" id="team-a-p1-nature" list="nature-list-calc" placeholder="Ej: Timid"></div>
                    <div class="form-group"><label>EVs:</label><div class="evs-grid-calc">
                        <div><label for="team-a-p1-ev-hp">HP</label><input type="number" id="team-a-p1-ev-hp" data-team="a" data-poke="1" data-stat="hp" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-a-p1-ev-atk">Atk</label><input type="number" id="team-a-p1-ev-atk" data-team="a" data-poke="1" data-stat="atk" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-a-p1-ev-def">Def</label><input type="number" id="team-a-p1-ev-def" data-team="a" data-poke="1" data-stat="def" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-a-p1-ev-spa">SpA</label><input type="number" id="team-a-p1-ev-spa" data-team="a" data-poke="1" data-stat="spa" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-a-p1-ev-spd">SpD</label><input type="number" id="team-a-p1-ev-spd" data-team="a" data-poke="1" data-stat="spd" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-a-p1-ev-spe">Spe</label><input type="number" id="team-a-p1-ev-spe" data-team="a" data-poke="1" data-stat="spe" class="ev-input-calc" value="0" min="0" max="252"></div>
                    </div><div class="ev-total-calc" id="team-a-p1-ev-total">Total EVs: 0 / 508</div></div>
                    <div class="form-group"><label for="team-a-p1-teratype">Teratipo:</label><input type="text" id="team-a-p1-teratype" list="type-list-calc" placeholder="Ej: Water"></div>
                    <div class="form-group"><label>Movimientos:</label>
                        <input type="text" id="team-a-p1-move1" list="move-list-calc" placeholder="Movimiento 1"><input type="text" id="team-a-p1-move2" list="move-list-calc" placeholder="Movimiento 2">
                        <input type="text" id="team-a-p1-move3" list="move-list-calc" placeholder="Movimiento 3"><input type="text" id="team-a-p1-move4" list="move-list-calc" placeholder="Movimiento 4">
                    </div>
                    <div class="form-group"><label for="team-a-p1-load">Cargar de mis equipos:</label><select id="team-a-p1-load"><option value="">Seleccionar Pokémon guardado...</option></select></div>
                </div>
            </div>

            <div class="team-setup-column" id="team-b-setup">
                <h3>Equipo B (Defensor)</h3>
                 <div class="pokemon-slot" id="team-b-poke-1">
                    <h4>Pokémon 1</h4>
                    <div class="form-group"><label for="team-b-p1-name">Nombre:</label><input type="text" id="team-b-p1-name" list="pokemon-list-calc"></div>
                    <div class="form-group"><label for="team-b-p1-level">Nivel:</label><input type="number" id="team-b-p1-level" value="50" min="1" max="100"></div>
                    <div class="form-group"><label for="team-b-p1-item">Objeto:</label><input type="text" id="team-b-p1-item" list="item-list-calc"></div>
                    <div class="form-group"><label for="team-b-p1-ability">Habilidad:</label><input type="text" id="team-b-p1-ability" list="ability-list-calc"></div>
                    <div class="form-group"><label for="team-b-p1-nature">Naturaleza:</label><input type="text" id="team-b-p1-nature" list="nature-list-calc"></div>
                    <div class="form-group"><label>EVs:</label><div class="evs-grid-calc">
                        <div><label for="team-b-p1-ev-hp">HP</label><input type="number" id="team-b-p1-ev-hp" data-team="b" data-poke="1" data-stat="hp" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-b-p1-ev-atk">Atk</label><input type="number" id="team-b-p1-ev-atk" data-team="b" data-poke="1" data-stat="atk" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-b-p1-ev-def">Def</label><input type="number" id="team-b-p1-ev-def" data-team="b" data-poke="1" data-stat="def" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-b-p1-ev-spa">SpA</label><input type="number" id="team-b-p1-ev-spa" data-team="b" data-poke="1" data-stat="spa" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-b-p1-ev-spd">SpD</label><input type="number" id="team-b-p1-ev-spd" data-team="b" data-poke="1" data-stat="spd" class="ev-input-calc" value="0" min="0" max="252"></div>
                        <div><label for="team-b-p1-ev-spe">Spe</label><input type="number" id="team-b-p1-ev-spe" data-team="b" data-poke="1" data-stat="spe" class="ev-input-calc" value="0" min="0" max="252"></div>
                    </div><div class="ev-total-calc" id="team-b-p1-ev-total">Total EVs: 0 / 508</div></div>
                    <div class="form-group"><label for="team-b-p1-teratype">Teratipo:</label><input type="text" id="team-b-p1-teratype" list="type-list-calc"></div>
                    <div class="form-group"><label for="team-b-p1-load">Cargar de mis equipos:</label><select id="team-b-p1-load"><option value="">Seleccionar Pokémon guardado...</option></select></div>
                </div>
            </div>
        </div>

        <div class="attack-phase">
            <h3>Fase de Ataque</h3>
            <div class="attack-selectors">
                <div class="form-group"><label for="attacker-select">Atacante:</label><select id="attacker-select"><option value="team-a-p1">Pokémon 1 (A)</option></select></div>
                <div class="form-group"><label for="defender-select">Defensor:</label><select id="defender-select"><option value="team-b-p1">Pokémon 1 (B)</option></select></div>
                <div class="form-group"><label for="move-select">Movimiento a Usar:</label><select id="move-select"><option value="">Selecciona un movimiento...</option></select></div>
            </div>
            
            <h4>Modificadores de Combate:</h4>
            <div class="modifiers-grid">
                <div class="modifier-group">
                    <label>Clima:</label>
                    <select id="weather-condition">
                        <option value="none">Ninguno</option><option value="sun">Sol</option><option value="rain">Lluvia</option>
                        <option value="sand">Arena</option><option value="snow">Nieve</option>
                    </select>
                </div>
                <div class="modifier-group">
                    <label>Campo:</label>
                    <select id="terrain-condition">
                        <option value="none">Ninguno</option><option value="electric">Eléctrico</option><option value="grassy">Hierba</option>
                        <option value="psychic">Psíquico</option><option value="misty">Niebla</option>
                    </select>
                </div>
                 <div class="modifier-group">
                    <label>Atacante:</label>
                    <label class="checkbox-label"><input type="checkbox" id="attacker-crit"> Golpe Crítico</label>
                    <label class="checkbox-label"><input type="checkbox" id="attacker-burn"> Quemado</label>
                    <label class="checkbox-label"><input type="checkbox" id="attacker-life-orb"> Vidasfera</label>
                    <label class="checkbox-label"><input type="checkbox" id="attacker-metronome"> Metrónomo (1 uso)</label>
                    <label class="checkbox-label"><input type="checkbox" id="attacker-helping-hand"> Con Ayuda</label>
                </div>
                <div class="modifier-group">
                    <label>Defensor:</label>
                    <label class="checkbox-label"><input type="checkbox" id="defender-reflect"> Reflejo Activo</label>
                    <label class="checkbox-label"><input type="checkbox" id="defender-light-screen"> Pantalla Luz Activa</label>
                </div>
            </div>

            <button id="calculate-damage-button" class="calculate-button">Calcular Daño</button>
            <div class="results-section">
                <h4>Resultados:</h4>
                <pre id="calc-output">Esperando cálculo...</pre>
            </div>
        </div>
    </main>

    <footer></footer>

    <datalist id="pokemon-list-calc"></datalist>
    <datalist id="item-list-calc"></datalist>
    <datalist id="ability-list-calc"></datalist>
    <datalist id="move-list-calc"></datalist>
    <datalist id="nature-list-calc">
        <option value="Adamant"></option><option value="Bashful"></option><option value="Bold"></option><option value="Brave"></option><option value="Calm"></option><option value="Careful"></option><option value="Docile"></option><option value="Gentle"></option><option value="Hardy"></option><option value="Hasty"></option><option value="Impish"></option><option value="Jolly"></option><option value="Lax"></option><option value="Lonely"></option><option value="Mild"></option><option value="Modest"></option><option value="Naive"></option><option value="Naughty"></option><option value="Quiet"></option><option value="Quirky"></option><option value="Rash"></option><option value="Relaxed"></option><option value="Sassy"></option><option value="Serious"></option><option value="Timid"></option>
    </datalist>
    <datalist id="type-list-calc">
        <option value="Normal"></option><option value="Fire"></option><option value="Water"></option><option value="Electric"></option><option value="Grass"></option><option value="Ice"></option><option value="Fighting"></option><option value="Poison"></option><option value="Ground"></option><option value="Flying"></option><option value="Psychic"></option><option value="Bug"></option><option value="Rock"></option><option value="Ghost"></option><option value="Dragon"></option><option value="Dark"></option><option value="Steel"></option><option value="Fairy"></option>
    </datalist>

    <script>
        const TYPE_EFFECTIVENESS_CALC = {
            normal: { rock: 0.5, steel: 0.5, ghost: 0 }, fire: { fire: 0.5, water: 0.5, grass: 2, ice: 2, bug: 2, rock: 0.5, dragon: 0.5, steel: 2 },
            water: { fire: 2, water: 0.5, grass: 0.5, ground: 2, rock: 2, dragon: 0.5 }, electric: { water: 2, grass: 0.5, electric: 0.5, ground: 0, flying: 2, dragon: 0.5 },
            grass: { fire: 0.5, water: 2, grass: 0.5, poison: 0.5, ground: 2, flying: 0.5, bug: 0.5, rock: 2, dragon: 0.5, steel: 0.5 }, ice: { fire: 0.5, water: 0.5, grass: 2, ice: 0.5, ground: 2, flying: 2, dragon: 2, steel: 0.5 },
            fighting: { normal: 2, ice: 2, poison: 0.5, flying: 0.5, psychic: 0.5, bug: 0.5, rock: 2, ghost: 0, dark: 2, steel: 2, fairy: 0.5 }, poison: { grass: 2, poison: 0.5, ground: 0.5, rock: 0.5, ghost: 0.5, steel: 0, fairy: 2 },
            ground: { fire: 2, grass: 0.5, electric: 2, poison: 2, flying: 0, bug: 0.5, rock: 2, steel: 2 }, flying: { grass: 2, electric: 0.5, fighting: 2, bug: 2, rock: 0.5, steel: 0.5 },
            psychic: { fighting: 2, poison: 2, psychic: 0.5, dark: 0, steel: 0.5 }, bug: { fire: 0.5, grass: 2, fighting: 0.5, poison: 0.5, flying: 0.5, psychic: 2, ghost: 0.5, dark: 2, steel: 0.5, fairy: 0.5 },
            rock: { fire: 2, ice: 2, fighting: 0.5, ground: 0.5, flying: 2, bug: 2, steel: 0.5 }, ghost: { normal: 0, psychic: 2, ghost: 2, dark: 0.5 },
            dragon: { dragon: 2, steel: 0.5, fairy: 0 }, dark: { fighting: 0.5, psychic: 2, ghost: 2, dark: 0.5, fairy: 0.5 },
            steel: { fire: 0.5, water: 0.5, electric: 0.5, ice: 2, rock: 2, steel: 0.5, fairy: 2 }, fairy: { fire: 0.5, fighting: 2, poison: 0.5, dragon: 2, dark: 2, steel: 0.5 }
        };
        const ALL_TYPES_CALC = ["normal", "fire", "water", "electric", "grass", "ice", "fighting", "poison", "ground", "flying", "psychic", "bug", "rock", "ghost", "dragon", "dark", "steel", "fairy"];
        const NATURES_CALC = {
            Adamant: { atk: 1.1, spa: 0.9 }, Bold: { def: 1.1, atk: 0.9 }, Brave: { atk: 1.1, spe: 0.9 }, Calm: { spd: 1.1, atk: 0.9 },
            Careful: { spd: 1.1, spa: 0.9 }, Gentle: { spd: 1.1, def: 0.9 }, Hasty: { spe: 1.1, def: 0.9 }, Impish: { def: 1.1, spa: 0.9 },
            Jolly: { spe: 1.1, spa: 0.9 }, Lax: { def: 1.1, spd: 0.9 }, Lonely: { atk: 1.1, def: 0.9 }, Mild: { spa: 1.1, def: 0.9 },
            Modest: { spa: 1.1, atk: 0.9 }, Naive: { spe: 1.1, spd: 0.9 }, Naughty: { atk: 1.1, spd: 0.9 }, Quiet: { spa: 1.1, spe: 0.9 },
            Rash: { spa: 1.1, spd: 0.9 }, Relaxed: { def: 1.1, spe: 0.9 }, Sassy: { spd: 1.1, spe: 0.9 }, Timid: { spe: 1.1, atk: 0.9 },
            Bashful: {}, Docile: {}, Hardy: {}, Quirky: {}, Serious: {}
        };

        document.addEventListener('DOMContentLoaded', () => {
            const pokemonDatalist = document.getElementById('pokemon-list-calc');
            const itemDatalist = document.getElementById('item-list-calc');
            const abilityDatalist = document.getElementById('ability-list-calc');
            const moveDatalist = document.getElementById('move-list-calc');
            
            async function populateDatalistCalc(url, datalistElement, nameKey = 'name', processFn = (name) => name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())) {
                if (!datalistElement) return;
                try {
                    let allResults = []; let nextUrl = url; let count = 0;
                    while (nextUrl && count < 20) {
                        const response = await fetch(nextUrl);
                        if (!response.ok) { console.warn(`API error for ${url} (page ${count+1}): ${response.status}`); break; }
                        const data = await response.json();
                        allResults = allResults.concat(data.results);
                        nextUrl = data.next; count++;
                    }
                    allResults.sort((a, b) => a[nameKey].localeCompare(b[nameKey]));
                    datalistElement.innerHTML = ''; 
                    allResults.forEach(item => {
                        const option = document.createElement('option');
                        option.value = processFn(item[nameKey]);
                        datalistElement.appendChild(option);
                    });
                } catch (error) { console.error(`Error populando datalist desde ${url}:`, error); }
            }
            const pokemonNameProcessorCalc = name => name.charAt(0).toUpperCase() + name.slice(1).replace(/-/g, ' ');
            populateDatalistCalc('https://pokeapi.co/api/v2/pokemon?limit=10000', pokemonDatalist, 'name', pokemonNameProcessorCalc);
            populateDatalistCalc('https://pokeapi.co/api/v2/item?limit=2000', itemDatalist);
            populateDatalistCalc('https://pokeapi.co/api/v2/ability?limit=500', abilityDatalist);
            populateDatalistCalc('https://pokeapi.co/api/v2/move?limit=1000', moveDatalist);

            document.querySelectorAll('.ev-input-calc').forEach(input => {
                input.addEventListener('input', (event) => {
                    const team = event.target.dataset.team;
                    const pokeIdx = event.target.dataset.poke;
                    let totalEVs = 0;
                    document.querySelectorAll(`.ev-input-calc[data-team="${team}"][data-poke="${pokeIdx}"]`).forEach(evField => {
                        let val = parseInt(evField.value) || 0;
                        if (val < 0) val = 0; if (val > 252) val = 252;
                        evField.value = val; totalEVs += val;
                    });
                    const totalDisplay = document.getElementById(`team-${team}-p${pokeIdx}-ev-total`);
                    if (totalDisplay) {
                        totalDisplay.textContent = `Total EVs: ${totalEVs} / 508`;
                        totalDisplay.style.color = totalEVs > 508 ? 'var(--danger)' : 'var(--dark)';
                    }
                });
            });

            const allTeamsData = JSON.parse(localStorage.getItem('allTeamsData')) || {};
            ['team-a-p1-load', 'team-b-p1-load'].forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    Object.values(allTeamsData).forEach(team => {
                        (team.pokemons || []).forEach((pokemon, index) => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify({teamId: team.id, pokemonIndex: index});
                            option.textContent = `${team.title} - ${pokemon.name}`;
                            selectElement.appendChild(option);
                        });
                    });
                    selectElement.addEventListener('change', (event) => { /* ... (tu lógica de carga de Pokémon guardado) ... */ });
                }
            });
            
            const attackerNameInput = document.getElementById('team-a-p1-name');
            const moveInputsAttacker = [
                document.getElementById('team-a-p1-move1'), document.getElementById('team-a-p1-move2'),
                document.getElementById('team-a-p1-move3'), document.getElementById('team-a-p1-move4')
            ];
            
            function updateMoveSelector() { /* ... (tu lógica para actualizar el selector de movimientos) ... */ }
            moveInputsAttacker.forEach(input => { if(input) input.addEventListener('change', updateMoveSelector); });
            if(attackerNameInput) attackerNameInput.addEventListener('change', updateMoveSelector);

            const calculateButton = document.getElementById('calculate-damage-button');
            const calcOutput = document.getElementById('calc-output');

            if (calculateButton) {
                calculateButton.addEventListener('click', async () => {
                    calcOutput.textContent = "Calculando...";
                    try {
                        const attackerId = document.getElementById('attacker-select').value;
                        const defenderId = document.getElementById('defender-select').value;
                        const moveName = document.getElementById('move-select').value;

                        if (!moveName) { calcOutput.textContent = "Por favor, selecciona un movimiento."; return; }

                        const attackerFormData = getPokemonDetailsFromForm(attackerId.split('-')[0], attackerId.split('-')[2]);
                        const defenderFormData = getPokemonDetailsFromForm(defenderId.split('-')[0], defenderId.split('-')[2]);

                        if (!attackerFormData.name || !defenderFormData.name) { calcOutput.textContent = "Por favor, define ambos Pokémon."; return; }
                        
                        const [attackerApi, defenderApi, moveApi] = await Promise.all([
                            fetchFromPokeAPI(`pokemon/${attackerFormData.name.toLowerCase().replace(/\s+/g, '-')}`),
                            fetchFromPokeAPI(`pokemon/${defenderFormData.name.toLowerCase().replace(/\s+/g, '-')}`),
                            fetchFromPokeAPI(`move/${moveName.toLowerCase().replace(/\s+/g, '-')}`)
                        ]);

                        if (!attackerApi || !defenderApi || !moveApi) { calcOutput.textContent = "Error: No se pudieron obtener todos los datos de PokéAPI."; return; }
                        
                        const attackerStats = calculateFinalStats(attackerApi, attackerFormData);
                        const defenderStats = calculateFinalStats(defenderApi, defenderFormData);

                        // Leer modificadores
                        const modifiers = {
                            isCrit: document.getElementById('attacker-crit').checked,
                            attackerBurned: document.getElementById('attacker-burn').checked,
                            defenderReflect: document.getElementById('defender-reflect').checked,
                            defenderLightScreen: document.getElementById('defender-light-screen').checked,
                            helpingHand: document.getElementById('attacker-helping-hand').checked,
                            weather: document.getElementById('weather-condition').value,
                            terrain: document.getElementById('terrain-condition').value,
                            attackerLifeOrb: document.getElementById('attacker-life-orb').checked,
                            attackerMetronome: document.getElementById('attacker-metronome').checked,
                        };
                        
                        const damageResult = calculateDamage(attackerStats, defenderStats, attackerApi, defenderApi, moveApi, attackerFormData, defenderFormData, modifiers);
                        
                        let outputText = `--- Simulación de Combate ---\n`;
                        outputText += `${attackerFormData.name} (${attackerFormData.ability || 'Sin habilidad'}) @ ${attackerFormData.item || 'Ninguno'}\n`;
                        outputText += `Movimiento: ${moveApi.names.find(n=>n.language.name==='es')?.name || moveName} (Tipo: ${moveApi.type.name}, Poder: ${moveApi.power || 'N/A'})\n`;
                        outputText += `Contra: ${defenderFormData.name} (${defenderFormData.ability || 'Sin habilidad'}) @ ${defenderFormData.item || 'Ninguno'}\n`;
                        
                        if (damageResult.damageValues.length > 0) {
                            const minDamage = Math.min(...damageResult.damageValues);
                            const maxDamage = Math.max(...damageResult.damageValues);
                            const avgDamage = damageResult.damageValues.reduce((a, b) => a + b, 0) / damageResult.damageValues.length;
                            
                            const minPercent = (minDamage / defenderStats.hp) * 100;
                            const maxPercent = (maxDamage / defenderStats.hp) * 100;
                            const avgPercent = (avgDamage / defenderStats.hp) * 100;

                            outputText += `Daño: ${Math.round(minDamage)} - ${Math.round(maxDamage)} (${minPercent.toFixed(1)}% - ${maxPercent.toFixed(1)}%)\n`;
                            outputText += `Promedio: ${Math.round(avgDamage)} (${avgPercent.toFixed(1)}%)\n`;
                            
                            if (maxDamage >= defenderStats.hp) outputText += `Posible KO!\n`;
                            else if (avgDamage >= defenderStats.hp) outputText += `KO probable!\n`;

                        } else { outputText += "El movimiento no hace daño o es de estado.\n"; }
                        
                        outputText += `\n--- Modificadores Aplicados ---\n`;
                        outputText += `STAB: ${damageResult.stabApplied ? 'Sí' : 'No'}\n`;
                        outputText += `Efectividad de Tipo: x${damageResult.effectivenessMultiplier}\n`;
                        if (damageResult.isCrit) outputText += `¡Golpe Crítico!\n`;
                        if (damageResult.attackerBurned && moveApi.damage_class.name === 'physical') outputText += `Ataque reducido por quemadura.\n`;
                        if (damageResult.screenApplied) outputText += `Daño reducido por ${damageResult.screenType}.\n`;
                        if (damageResult.weatherMod !== 1) outputText += `Modificador de Clima: x${damageResult.weatherMod}\n`;
                        if (damageResult.terrainMod !== 1) outputText += `Modificador de Campo: x${damageResult.terrainMod}\n`;
                        if (damageResult.itemMod !== 1) outputText += `Modificador de Objeto (Atacante): x${damageResult.itemMod.toFixed(2)}\n`;
                        if (damageResult.abilityMod !== 1) outputText += `Modificador de Habilidad (Atacante/Defensor): x${damageResult.abilityMod.toFixed(2)}\n`;


                        calcOutput.textContent = outputText;

                    } catch (error) {
                        console.error("Error en cálculo:", error);
                        calcOutput.textContent = `Error en el cálculo: ${error.message}`;
                    }
                });
            }

            function getPokemonDetailsFromForm(teamPrefix, pokeIdx) { /* ... (igual que antes) ... */ return {name: null};}
            function calculateFinalStats(pokemonApiData, formData) { /* ... (igual que antes) ... */ return {};}
            function calculateOtherStat(base, iv, ev, level, natureMod = 1) { /* ... (igual que antes) ... */ return 0;}

            function calculateDamage(attackerStats, defenderStats, attackerApi, defenderApi, moveApi, attackerFormData, defenderFormData, modifiers) {
                let damageValues = [];
                let effectivenessMultiplier = 1;
                let finalModifiers = { // Para loguear qué se aplicó
                    stabApplied: false, weatherMod: 1, terrainMod: 1, itemMod: 1, abilityMod: 1, screenApplied: false, screenType: '', attackerBurned: modifiers.attackerBurned, isCrit: modifiers.isCrit
                };


                if (moveApi.power == null || moveApi.power === 0) {
                    return { damageValues: [], effectivenessMultiplier: 1, ...finalModifiers };
                }

                const level = attackerFormData.level;
                let attackStatValue;
                let defenseStatValue;
                let movePower = moveApi.power;
                let moveType = moveApi.type.name;

                // Determinar stat de ataque/defensa
                if (moveApi.damage_class.name === 'physical') {
                    attackStatValue = attackerStats.atk;
                    defenseStatValue = defenderStats.def;
                    if (modifiers.attackerBurned && attackerFormData.ability?.toLowerCase() !== 'guts') {
                        attackStatValue *= 0.5;
                    }
                } else if (moveApi.damage_class.name === 'special') {
                    attackStatValue = attackerStats.spa;
                    defenseStatValue = defenderStats.spd;
                } else { // Status move
                    return { damageValues: [], effectivenessMultiplier: 1, ...finalModifiers };
                }

                // Modificadores de Poder Base
                if (modifiers.helpingHand) movePower *= 1.5;
                if (modifiers.attackerMetronome) movePower *= 1.2; // Simplificado a 1 uso

                // Habilidades que afectan el poder o tipo del movimiento (ejemplos)
                const attackerAbility = attackerFormData.ability?.toLowerCase();
                if (attackerAbility === 'technician' && movePower <= 60) { movePower *= 1.5; finalModifiers.abilityMod *= 1.5;}
                if ((attackerAbility === 'pixilate' || attackerAbility === 'refrigerate' || attackerAbility === 'aerilate') && moveApi.type.name === 'normal') {
                    if(attackerAbility === 'pixilate') moveType = 'fairy';
                    if(attackerAbility === 'refrigerate') moveType = 'ice';
                    if(attackerAbility === 'aerilate') moveType = 'flying';
                    movePower *= 1.2; // Potencia de las "-ate" abilities
                    finalModifiers.abilityMod *= 1.2;
                }


                // STAB
                let stab = 1;
                const attackerEffectiveTypes = attackerFormData.teraType ? [attackerFormData.teraType.toLowerCase()] : attackerApi.types.map(t => t.type.name);
                if (attackerEffectiveTypes.includes(moveType)) {
                    stab = (attackerAbility === 'adaptability') ? 2 : 1.5;
                    finalModifiers.stabApplied = true;
                }
                
                // Efectividad de Tipos
                const defenderEffectiveTypes = defenderFormData.teraType ? [defenderFormData.teraType.toLowerCase()] : defenderApi.types.map(t => t.type.name);
                effectivenessMultiplier = 1;
                defenderEffectiveTypes.forEach(defType => {
                    const typeChartEntry = TYPE_EFFECTIVENESS_CALC[moveType];
                    if (typeChartEntry && typeChartEntry[defType] !== undefined) {
                        effectivenessMultiplier *= typeChartEntry[defType];
                    }
                });
                // Habilidad Scrappy
                if (attackerAbility === 'scrappy' && (moveType === 'normal' || moveType === 'fighting') && defenderEffectiveTypes.includes('ghost')) {
                    if (effectivenessMultiplier === 0) effectivenessMultiplier = 1; // Anula inmunidad
                }


                // Modificador de Clima
                if (modifiers.weather === 'sun') {
                    if (moveType === 'fire') finalModifiers.weatherMod = 1.5;
                    else if (moveType === 'water') finalModifiers.weatherMod = 0.5;
                } else if (modifiers.weather === 'rain') {
                    if (moveType === 'water') finalModifiers.weatherMod = 1.5;
                    else if (moveType === 'fire') finalModifiers.weatherMod = 0.5;
                }

                // Modificador de Campo (simplificado, asume que los Pokémon están en tierra)
                if (modifiers.terrain === 'electric' && moveType === 'electric') finalModifiers.terrainMod = 1.3;
                if (modifiers.terrain === 'grassy' && moveType === 'grass') finalModifiers.terrainMod = 1.3;
                if (modifiers.terrain === 'psychic' && moveType === 'psychic') finalModifiers.terrainMod = 1.3;


                // Modificador de Objeto (Atacante)
                if (modifiers.attackerLifeOrb) finalModifiers.itemMod *= 1.3;
                // Aquí irían más objetos como Choice Band/Specs (afectan el stat, no el daño final directamente)

                // Habilidades Defensivas
                const defenderAbility = defenderFormData.ability?.toLowerCase();
                if ((defenderAbility === 'filter' || defenderAbility === 'solid-rock') && effectivenessMultiplier > 1) {
                    finalModifiers.abilityMod *= 0.75;
                }
                if (defenderAbility === 'thick-fat' && (moveType === 'fire' || moveType === 'ice')) {
                    finalModifiers.abilityMod *= 0.5;
                }


                // Fórmula de daño base
                let baseDamageFormulaPart = (((((2 * level) / 5) + 2) * movePower * (attackStatValue / defenseStatValue)) / 50) + 2;

                // Aplicar modificadores generales
                let finalDamageMultiplier = stab * effectivenessMultiplier * finalModifiers.weatherMod * finalModifiers.terrainMod * finalModifiers.itemMod * finalModifiers.abilityMod;

                // Golpe Crítico
                if (modifiers.isCrit) {
                    finalDamageMultiplier *= 1.5; 
                    // Los críticos ignoran pantallas y ciertos boosts/drops de stats,
                    // pero esta simplificación no lo modela completamente.
                }

                // Pantallas (Reflejo/Pantalla Luz) - se aplican después de otros multiplicadores, excepto el random.
                // Un crítico ignora las pantallas.
                if (!modifiers.isCrit) {
                    if (modifiers.defenderReflect && moveApi.damage_class.name === 'physical') {
                        finalDamageMultiplier *= 0.5; // Simplificado para singles
                        finalModifiers.screenApplied = true; finalModifiers.screenType = 'Reflejo';
                    }
                    if (modifiers.defenderLightScreen && moveApi.damage_class.name === 'special') {
                        finalDamageMultiplier *= 0.5; // Simplificado para singles
                        finalModifiers.screenApplied = true; finalModifiers.screenType = 'Pantalla Luz';
                    }
                }
                
                // Calcular los 16 valores de daño
                for (let i = 0; i < 16; i++) {
                    const randomFactor = (85 + i) / 100;
                    let damage = baseDamageFormulaPart * finalDamageMultiplier * randomFactor;
                    damageValues.push(Math.max(1, Math.floor(damage)));
                }
                
                return { damageValues, effectivenessMultiplier, ...finalModifiers };
            }
            
            function parseEVsCalc(evString) { /* ... (igual que antes) ... */ return {};}
            async function fetchFromPokeAPI(endpoint) {
                 try {
                    const response = await fetch(`https://pokeapi.co/api/v2/${endpoint}`);
                    if (!response.ok) { console.warn(`Recurso no encontrado en PokéAPI: ${endpoint} (Status: ${response.status})`); return null; }
                    return await response.json();
                } catch (error) { console.error(`Error fetching de PokéAPI (${endpoint}):`, error); return null; }
            }


        });
    </script>
</body>
</html>
